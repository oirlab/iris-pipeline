
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jwst.assign_wcs.nirspec &#8212; iris_pipeline v0.4.dev312</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">iris_pipeline</span><span id="logotext2"></span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">iris_pipeline v0.4.dev312</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            


  <h1>Source code for jwst.assign_wcs.nirspec</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Tools to create the WCS pipeline NIRSPEC modes.</span>

<span class="sd">Calls create_pipeline() which redirects based on EXP_TYPE.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.models</span> <span class="kn">import</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Identity</span><span class="p">,</span> <span class="n">Const1D</span><span class="p">,</span> <span class="n">Scale</span><span class="p">,</span> <span class="n">Tabular1D</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">coordinates</span> <span class="k">as</span> <span class="n">coord</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">gwcs</span> <span class="kn">import</span> <span class="n">coordinate_frames</span> <span class="k">as</span> <span class="n">cf</span>

<span class="kn">from</span> <span class="nn">..transforms.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Rotation3DToGWA</span><span class="p">,</span> <span class="n">DirCos2Unitless</span><span class="p">,</span> <span class="n">Slit2Msa</span><span class="p">,</span>
                                 <span class="n">AngleFromGratingEquation</span><span class="p">,</span> <span class="n">WavelengthFromGratingEquation</span><span class="p">,</span>
                                 <span class="n">Gwa2Slit</span><span class="p">,</span> <span class="n">Unitless2DirCos</span><span class="p">,</span> <span class="n">Logical</span><span class="p">,</span> <span class="n">Slit</span><span class="p">,</span> <span class="n">Snell</span><span class="p">,</span>
                                 <span class="n">RefractionIndexFromPrism</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MSAFileError</span><span class="p">,</span>
    <span class="n">NoDataOnDetectorError</span><span class="p">,</span>
    <span class="n">not_implemented_mode</span><span class="p">,</span>
    <span class="n">velocity_correction</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">pointing</span>
<span class="kn">from</span> <span class="nn">..datamodels</span> <span class="kn">import</span> <span class="p">(</span><span class="n">CollimatorModel</span><span class="p">,</span> <span class="n">CameraModel</span><span class="p">,</span> <span class="n">DisperserModel</span><span class="p">,</span> <span class="n">FOREModel</span><span class="p">,</span>
                          <span class="n">IFUFOREModel</span><span class="p">,</span> <span class="n">MSAModel</span><span class="p">,</span> <span class="n">OTEModel</span><span class="p">,</span> <span class="n">IFUPostModel</span><span class="p">,</span> <span class="n">IFUSlicerModel</span><span class="p">,</span>
                          <span class="n">WavelengthrangeModel</span><span class="p">,</span> <span class="n">FPAModel</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..lib.exposure_types</span> <span class="kn">import</span> <span class="n">is_nrs_ifu_lamp</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;create_pipeline&quot;</span><span class="p">,</span> <span class="s2">&quot;imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;ifu&quot;</span><span class="p">,</span> <span class="s2">&quot;slits_wcs&quot;</span><span class="p">,</span> <span class="s2">&quot;get_open_slits&quot;</span><span class="p">,</span> <span class="s2">&quot;nrs_wcs_set_input&quot;</span><span class="p">,</span>
           <span class="s2">&quot;nrs_ifu_wcs&quot;</span><span class="p">,</span> <span class="s2">&quot;get_spectral_order_wrange&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">create_pipeline</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a pipeline list based on EXP_TYPE.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : `~jwst.datamodels.ImageModel`, `~jwst.datamodels.IFUImageModel`, `~jwst.datamodels.CubeModel`</span>
<span class="sd">        The input exposure.</span>
<span class="sd">    reference_files : dict</span>
<span class="sd">        {reftype: reference_file_name} mapping.</span>
<span class="sd">    slit_y_range : list</span>
<span class="sd">        The slit Y-range for Nirspec slits, relative to (0, 0) in the center.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exp_type</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">grating</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;mirror&quot;</span><span class="p">:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">imaging</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">exp_type2transform</span><span class="p">[</span><span class="n">exp_type</span><span class="p">](</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="o">=</span><span class="n">slit_y_range</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pipeline</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created a NIRSPEC </span><span class="si">{0}</span><span class="s2"> pipeline with references </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">exp_type</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pipeline</span>


<span class="k">def</span> <span class="nf">imaging</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Imaging pipeline.</span>

<span class="sd">    It has the following coordinate frames:</span>
<span class="sd">    &quot;detector&quot; : the science frame</span>
<span class="sd">    &quot;sca&quot; : frame associated with the SCA</span>
<span class="sd">    &quot;gwa&quot; &quot; just before the GWA going from detector to sky</span>
<span class="sd">    &quot;msa_frame&quot; : at the MSA</span>
<span class="sd">    &quot;oteip&quot; : after the FWA</span>
<span class="sd">    &quot;v2v3&quot; and &quot;world&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the corrected disperser model</span>
    <span class="n">disperser</span> <span class="o">=</span> <span class="n">get_disperser</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;disperser&#39;</span><span class="p">])</span>

    <span class="c1"># DMS to SCA transform</span>
    <span class="n">dms2detector</span> <span class="o">=</span> <span class="n">dms_to_sca</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span>

    <span class="c1"># DETECTOR to GWA transform</span>
    <span class="n">det2gwa</span> <span class="o">=</span> <span class="n">detector_to_gwa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span><span class="p">,</span> <span class="n">disperser</span><span class="p">)</span>

    <span class="n">gwa_through</span> <span class="o">=</span> <span class="n">Const1D</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Const1D</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;theta_x&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;theta_y&#39;</span><span class="p">],</span>
               <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;theta_z&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;tilt_y&#39;</span><span class="p">]]</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="n">Rotation3DToGWA</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;xyzy&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">inverse</span>
    <span class="n">dircos2unitless</span> <span class="o">=</span> <span class="n">DirCos2Unitless</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;directional_cosines2unitless&#39;</span><span class="p">)</span>

    <span class="n">col_model</span> <span class="o">=</span> <span class="n">CollimatorModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;collimator&#39;</span><span class="p">])</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">col_model</span><span class="o">.</span><span class="n">model</span>
    <span class="n">col_model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Get the default spectral order and wavelength range and record them in the model.</span>
    <span class="n">sporder</span><span class="p">,</span> <span class="n">wrange</span> <span class="o">=</span> <span class="n">get_spectral_order_wrange</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;wavelengthrange&#39;</span><span class="p">])</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_start</span> <span class="o">=</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_end</span> <span class="o">=</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">spectral_order</span> <span class="o">=</span> <span class="n">sporder</span>

    <span class="n">lam</span> <span class="o">=</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">wrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>

    <span class="n">lam_model</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Const1D</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>

    <span class="n">gwa2msa</span> <span class="o">=</span> <span class="n">gwa_through</span> <span class="o">|</span> <span class="n">rotation</span> <span class="o">|</span> <span class="n">dircos2unitless</span> <span class="o">|</span> <span class="n">col</span> <span class="o">|</span> <span class="n">lam_model</span>
    <span class="n">gwa2msa</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">inverse</span> <span class="o">|</span> <span class="n">dircos2unitless</span><span class="o">.</span><span class="n">inverse</span> <span class="o">|</span> <span class="n">rotation</span><span class="o">.</span><span class="n">inverse</span> <span class="o">|</span> <span class="n">gwa_through</span>

    <span class="c1"># Create coordinate frames in the NIRSPEC WCS pipeline</span>
    <span class="c1"># &quot;detector&quot;, &quot;gwa&quot;, &quot;msa&quot;, &quot;oteip&quot;, &quot;v2v3&quot;, &quot;world&quot;</span>
    <span class="n">det</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">gwa</span><span class="p">,</span> <span class="n">msa_frame</span><span class="p">,</span> <span class="n">oteip</span><span class="p">,</span> <span class="n">v2v3</span><span class="p">,</span> <span class="n">world</span> <span class="o">=</span> <span class="n">create_imaging_frames</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span> <span class="o">!=</span> <span class="s1">&#39;OPAQUE&#39;</span><span class="p">:</span>
        <span class="c1"># MSA to OTEIP transform</span>
        <span class="n">msa2ote</span> <span class="o">=</span> <span class="n">msa_to_oteip</span><span class="p">(</span><span class="n">reference_files</span><span class="p">)</span>
        <span class="n">msa2oteip</span> <span class="o">=</span> <span class="n">msa2ote</span> <span class="o">|</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">map1</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">minv</span> <span class="o">=</span> <span class="n">msa2ote</span><span class="o">.</span><span class="n">inverse</span>
        <span class="k">del</span> <span class="n">minv</span><span class="o">.</span><span class="n">inverse</span>
        <span class="n">msa2oteip</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">map1</span> <span class="o">|</span> <span class="n">minv</span> <span class="o">|</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># OTEIP to V2,V3 transform</span>
        <span class="k">with</span> <span class="n">OTEModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;ote&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">oteip2v23</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">model</span>

        <span class="c1"># V2, V3 to world (RA, DEC) transform</span>
        <span class="n">tel2sky</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">v23tosky</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span>

        <span class="n">imaging_pipeline</span> <span class="o">=</span> <span class="p">[(</span><span class="n">det</span><span class="p">,</span> <span class="n">dms2detector</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">sca</span><span class="p">,</span> <span class="n">det2gwa</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">gwa</span><span class="p">,</span> <span class="n">gwa2msa</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">msa_frame</span><span class="p">,</span> <span class="n">msa2oteip</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">oteip</span><span class="p">,</span> <span class="n">oteip2v23</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">v2v3</span><span class="p">,</span> <span class="n">tel2sky</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># convert to microns if the pipeline ends earlier</span>
        <span class="n">gwa2msa</span> <span class="o">=</span> <span class="p">(</span><span class="n">gwa2msa</span> <span class="o">|</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Scale</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;gwa2msa&#39;</span><span class="p">)</span>
        <span class="n">imaging_pipeline</span> <span class="o">=</span> <span class="p">[(</span><span class="n">det</span><span class="p">,</span> <span class="n">dms2detector</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">sca</span><span class="p">,</span> <span class="n">det2gwa</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">gwa</span><span class="p">,</span> <span class="n">gwa2msa</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">msa_frame</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">imaging_pipeline</span>


<span class="k">def</span> <span class="nf">ifu</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="o">=</span><span class="p">[</span><span class="o">-.</span><span class="mi">55</span><span class="p">,</span> <span class="o">.</span><span class="mi">55</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Nirspec IFU WCS pipeline.</span>

<span class="sd">    The coordinate frames are:</span>
<span class="sd">    &quot;detector&quot; : the science frame</span>
<span class="sd">    &quot;sca&quot; : frame associated with the SCA</span>
<span class="sd">    &quot;gwa&quot; &quot; just before the GWA going from detector to sky</span>
<span class="sd">    &quot;slit_frame&quot; : frame associated with the virtual slit</span>
<span class="sd">    &quot;slicer&#39; : frame associated with the slicer</span>
<span class="sd">    &quot;msa_frame&quot; : at the MSA</span>
<span class="sd">    &quot;oteip&quot; : after the FWA</span>
<span class="sd">    &quot;v2v3&quot; and &quot;world&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : `~jwst.datamodels.DataModel`</span>
<span class="sd">        The input data model.</span>
<span class="sd">    reference_files : dict</span>
<span class="sd">        The reference files used for this mode.</span>
<span class="sd">    slit_y_range : list</span>
<span class="sd">        The slit dimensions relative to the center of the slit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span>
    <span class="n">grating</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">grating</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span>
    <span class="c1"># Check for ifu reference files</span>
    <span class="k">if</span> <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;ifufore&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> \
       <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;ifuslicer&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> \
       <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;ifupost&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># No ifu reference files, won&#39;t be able to create pipeline</span>
        <span class="n">log_message</span> <span class="o">=</span> <span class="s1">&#39;No ifufore, ifuslicer or ifupost reference files&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
    <span class="c1"># Check for data actually being present on NRS2</span>
    <span class="n">log_message</span> <span class="o">=</span> <span class="s2">&quot;No IFU slices fall on detector </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">detector</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">detector</span> <span class="o">==</span> <span class="s2">&quot;NRS2&quot;</span> <span class="ow">and</span> <span class="n">grating</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">):</span>
        <span class="c1"># Mid-resolution gratings do not project on NRS2.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">NoDataOnDetectorError</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">detector</span> <span class="o">==</span> <span class="s2">&quot;NRS2&quot;</span> <span class="ow">and</span> <span class="n">grating</span> <span class="o">==</span> <span class="s2">&quot;G140H&quot;</span> <span class="ow">and</span> <span class="nb">filter</span> <span class="o">==</span> <span class="s2">&quot;F070LP&quot;</span><span class="p">:</span>
        <span class="c1"># This combination of grating and filter does not project on NRS2.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">NoDataOnDetectorError</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>

    <span class="n">slits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
    <span class="c1"># Get the corrected disperser model</span>
    <span class="n">disperser</span> <span class="o">=</span> <span class="n">get_disperser</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;disperser&#39;</span><span class="p">])</span>

    <span class="c1"># Get the default spectral order and wavelength range and record them in the model.</span>
    <span class="n">sporder</span><span class="p">,</span> <span class="n">wrange</span> <span class="o">=</span> <span class="n">get_spectral_order_wrange</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;wavelengthrange&#39;</span><span class="p">])</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_start</span> <span class="o">=</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_end</span> <span class="o">=</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">spectral_order</span> <span class="o">=</span> <span class="n">sporder</span>

    <span class="c1"># DMS to SCA transform</span>
    <span class="n">dms2detector</span> <span class="o">=</span> <span class="n">dms_to_sca</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span>
    <span class="c1"># DETECTOR to GWA transform</span>
    <span class="n">det2gwa</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">detector_to_gwa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span>
                                            <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span><span class="p">,</span>
                                            <span class="n">disperser</span><span class="p">)</span>

    <span class="c1"># GWA to SLIT</span>
    <span class="n">gwa2slit</span> <span class="o">=</span> <span class="n">gwa_to_ifuslit</span><span class="p">(</span><span class="n">slits</span><span class="p">,</span> <span class="n">input_model</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">)</span>

    <span class="c1"># SLIT to MSA transform</span>
    <span class="n">slit2slicer</span> <span class="o">=</span> <span class="n">ifuslit_to_slicer</span><span class="p">(</span><span class="n">slits</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">input_model</span><span class="p">)</span>

    <span class="c1"># SLICER to MSA Entrance</span>
    <span class="n">slicer2msa</span> <span class="o">=</span> <span class="n">slicer_to_msa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">)</span>

    <span class="n">det</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">gwa</span><span class="p">,</span> <span class="n">slit_frame</span><span class="p">,</span> <span class="n">msa_frame</span><span class="p">,</span> <span class="n">oteip</span><span class="p">,</span> <span class="n">v2v3</span><span class="p">,</span> <span class="n">world</span> <span class="o">=</span> <span class="n">create_frames</span><span class="p">()</span>

    <span class="n">exp_type</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="n">is_lamp_exposure</span> <span class="o">=</span> <span class="n">exp_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NRS_LAMP&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_AUTOWAVE&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_AUTOFLAT&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span> <span class="o">==</span> <span class="s1">&#39;OPAQUE&#39;</span> <span class="ow">or</span> <span class="n">is_lamp_exposure</span><span class="p">:</span>
        <span class="c1"># If filter is &quot;OPAQUE&quot; or if internal lamp exposure the NIRSPEC WCS pipeline stops at the MSA.</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[(</span><span class="n">det</span><span class="p">,</span> <span class="n">dms2detector</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">sca</span><span class="p">,</span> <span class="n">det2gwa</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;detector2gwa&#39;</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">gwa</span><span class="p">,</span> <span class="n">gwa2slit</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;gwa2slit&#39;</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">slit_frame</span><span class="p">,</span> <span class="n">slit2slicer</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;slicer&#39;</span><span class="p">,</span> <span class="n">slicer2msa</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">msa_frame</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># MSA to OTEIP transform</span>
        <span class="n">msa2oteip</span> <span class="o">=</span> <span class="n">ifu_msa_to_oteip</span><span class="p">(</span><span class="n">reference_files</span><span class="p">)</span>
        <span class="c1"># OTEIP to V2,V3 transform</span>
        <span class="c1"># This includes a wavelength unit conversion from meters to microns.</span>
        <span class="n">oteip2v23</span> <span class="o">=</span> <span class="n">oteip_to_v23</span><span class="p">(</span><span class="n">reference_files</span><span class="p">)</span>

        <span class="c1"># V2, V3 to sky</span>
        <span class="n">tel2sky</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">v23tosky</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create coordinate frames in the NIRSPEC WCS pipeline&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># The oteip2v2v3 transform converts the wavelength from meters (which is assumed</span>
        <span class="c1"># in the whole pipeline) to microns (which is the expected output)</span>
        <span class="c1">#</span>
        <span class="c1"># &quot;detector&quot;, &quot;gwa&quot;, &quot;slit_frame&quot;, &quot;msa_frame&quot;, &quot;oteip&quot;, &quot;v2v3&quot;, &quot;world&quot;</span>

        <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[(</span><span class="n">det</span><span class="p">,</span> <span class="n">dms2detector</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">sca</span><span class="p">,</span> <span class="n">det2gwa</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;detector2gwa&#39;</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">gwa</span><span class="p">,</span> <span class="n">gwa2slit</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;gwa2slit&#39;</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">slit_frame</span><span class="p">,</span> <span class="n">slit2slicer</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;slicer&#39;</span><span class="p">,</span> <span class="n">slicer2msa</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">msa_frame</span><span class="p">,</span> <span class="n">msa2oteip</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;msa2oteip&#39;</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">oteip</span><span class="p">,</span> <span class="n">oteip2v23</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;oteip2v23&#39;</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">v2v3</span><span class="p">,</span> <span class="n">tel2sky</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">pipeline</span>


<span class="k">def</span> <span class="nf">slits_wcs</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The WCS pipeline for MOS and fixed slits.</span>

<span class="sd">    The coordinate frames are:</span>
<span class="sd">    &quot;detector&quot; : the science frame</span>
<span class="sd">    &quot;sca&quot; : frame associated with the SCA</span>
<span class="sd">    &quot;gwa&quot; &quot; just before the GWA going from detector to sky</span>
<span class="sd">    &quot;slit_frame&quot; : frame associated with the virtual slit</span>
<span class="sd">    &quot;msa_frame&quot; : at the MSA</span>
<span class="sd">    &quot;oteip&quot; : after the FWA</span>
<span class="sd">    &quot;v2v3&quot; : at V2V3</span>
<span class="sd">    &quot;world&quot; : sky and spectral</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : `~jwst.datamodels.DataModel`</span>
<span class="sd">        The input data model.</span>
<span class="sd">    reference_files : dict</span>
<span class="sd">        The reference files used for this mode.</span>
<span class="sd">    slit_y_range : list</span>
<span class="sd">        The slit dimensions relative to the center of the slit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">open_slits_id</span> <span class="o">=</span> <span class="n">get_open_slits</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">open_slits_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">n_slits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">open_slits_id</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing WCS for </span><span class="si">{0}</span><span class="s2"> open slitlets&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_slits</span><span class="p">))</span>

    <span class="n">msa_pipeline</span> <span class="o">=</span> <span class="n">slitlets_wcs</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">open_slits_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">msa_pipeline</span>


<span class="k">def</span> <span class="nf">slitlets_wcs</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">open_slits_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create The WCS piepline for MOS and Fixed slits for the</span>
<span class="sd">    specific opened shutters/slits. ``slit_y_range`` is taken from</span>
<span class="sd">    ``slit.ymin`` and ``slit.ymax``.</span>

<span class="sd">    Note: This function is also used by the ``msaflagopen`` step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the corrected disperser model</span>
    <span class="n">disperser</span> <span class="o">=</span> <span class="n">get_disperser</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;disperser&#39;</span><span class="p">])</span>

    <span class="c1"># Get the default spectral order and wavelength range and record them in the model.</span>
    <span class="n">sporder</span><span class="p">,</span> <span class="n">wrange</span> <span class="o">=</span> <span class="n">get_spectral_order_wrange</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;wavelengthrange&#39;</span><span class="p">])</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_start</span> <span class="o">=</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_end</span> <span class="o">=</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SPORDER= </span><span class="si">{0}</span><span class="s2">, wrange=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sporder</span><span class="p">,</span> <span class="n">wrange</span><span class="p">))</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">spectral_order</span> <span class="o">=</span> <span class="n">sporder</span>

    <span class="c1"># DMS to SCA transform</span>
    <span class="n">dms2detector</span> <span class="o">=</span> <span class="n">dms_to_sca</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span>
    <span class="n">dms2detector</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;dms2sca&#39;</span>
    <span class="c1"># DETECTOR to GWA transform</span>
    <span class="n">det2gwa</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">detector_to_gwa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span>
                                            <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span><span class="p">,</span>
                                            <span class="n">disperser</span><span class="p">)</span>
    <span class="n">det2gwa</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;det2gwa&quot;</span>

    <span class="c1"># GWA to SLIT</span>
    <span class="n">gwa2slit</span> <span class="o">=</span> <span class="n">gwa_to_slit</span><span class="p">(</span><span class="n">open_slits_id</span><span class="p">,</span> <span class="n">input_model</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">)</span>
    <span class="n">gwa2slit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;gwa2slit&quot;</span>

    <span class="c1"># SLIT to MSA transform</span>
    <span class="n">slit2msa</span> <span class="o">=</span> <span class="n">slit_to_msa</span><span class="p">(</span><span class="n">open_slits_id</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;msa&#39;</span><span class="p">])</span>
    <span class="n">slit2msa</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;slit2msa&quot;</span>

    <span class="c1"># Create coordinate frames in the NIRSPEC WCS pipeline&quot;</span>
    <span class="c1"># &quot;detector&quot;, &quot;gwa&quot;, &quot;slit_frame&quot;, &quot;msa_frame&quot;, &quot;oteip&quot;, &quot;v2v3&quot;, &quot;world&quot;</span>
    <span class="n">det</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">gwa</span><span class="p">,</span> <span class="n">slit_frame</span><span class="p">,</span> <span class="n">msa_frame</span><span class="p">,</span> <span class="n">oteip</span><span class="p">,</span> <span class="n">v2v3</span><span class="p">,</span> <span class="n">world</span> <span class="o">=</span> <span class="n">create_frames</span><span class="p">()</span>

    <span class="n">exp_type</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="n">is_lamp_exposure</span> <span class="o">=</span> <span class="n">exp_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NRS_LAMP&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_AUTOWAVE&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_AUTOFLAT&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span> <span class="o">==</span> <span class="s1">&#39;OPAQUE&#39;</span> <span class="ow">or</span> <span class="n">is_lamp_exposure</span><span class="p">:</span>
        <span class="c1"># convert to microns if the pipeline ends earlier</span>
        <span class="n">msa_pipeline</span> <span class="o">=</span> <span class="p">[(</span><span class="n">det</span><span class="p">,</span> <span class="n">dms2detector</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">sca</span><span class="p">,</span> <span class="n">det2gwa</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">gwa</span><span class="p">,</span> <span class="n">gwa2slit</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">slit_frame</span><span class="p">,</span> <span class="n">slit2msa</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">msa_frame</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># MSA to OTEIP transform</span>
        <span class="n">msa2oteip</span> <span class="o">=</span> <span class="n">msa_to_oteip</span><span class="p">(</span><span class="n">reference_files</span><span class="p">)</span>
        <span class="n">msa2oteip</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;msa2oteip&quot;</span>

        <span class="c1"># OTEIP to V2,V3 transform</span>
        <span class="c1"># This includes a wavelength unit conversion from meters to microns.</span>
        <span class="n">oteip2v23</span> <span class="o">=</span> <span class="n">oteip_to_v23</span><span class="p">(</span><span class="n">reference_files</span><span class="p">)</span>
        <span class="n">oteip2v23</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;oteip2v23&quot;</span>

        <span class="c1"># V2, V3 to sky</span>
        <span class="n">tel2sky</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">v23tosky</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tel2sky</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;v2v3_to_sky&quot;</span>

        <span class="n">msa_pipeline</span> <span class="o">=</span> <span class="p">[(</span><span class="n">det</span><span class="p">,</span> <span class="n">dms2detector</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">sca</span><span class="p">,</span> <span class="n">det2gwa</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">gwa</span><span class="p">,</span> <span class="n">gwa2slit</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">slit_frame</span><span class="p">,</span> <span class="n">slit2msa</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">msa_frame</span><span class="p">,</span> <span class="n">msa2oteip</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">oteip</span><span class="p">,</span> <span class="n">oteip2v23</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">v2v3</span><span class="p">,</span> <span class="n">tel2sky</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">msa_pipeline</span>


<span class="k">def</span> <span class="nf">get_open_slits</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="o">=</span><span class="p">[</span><span class="o">-.</span><span class="mi">55</span><span class="p">,</span> <span class="o">.</span><span class="mi">55</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Return the opened slits/shutters in a MOS or Fixed Slits exposure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exp_type</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">lamp_mode</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">lamp_mode</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lamp_mode</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">lamp_mode</span> <span class="o">=</span> <span class="n">lamp_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lamp_mode</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
    <span class="k">if</span> <span class="n">exp_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nrs_msaspec&quot;</span><span class="p">,</span> <span class="s2">&quot;nrs_autoflat&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">((</span><span class="n">exp_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nrs_lamp&quot;</span><span class="p">,</span> <span class="s2">&quot;nrs_autowave&quot;</span><span class="p">])</span> <span class="ow">and</span> \
                                                        <span class="p">(</span><span class="n">lamp_mode</span> <span class="o">==</span> <span class="s2">&quot;msaspec&quot;</span><span class="p">)):</span>
        <span class="n">msa_metadata_file</span><span class="p">,</span> <span class="n">msa_metadata_id</span><span class="p">,</span> <span class="n">dither_point</span> <span class="o">=</span> <span class="n">get_msa_metadata</span><span class="p">(</span>
            <span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">)</span>
        <span class="n">slits</span> <span class="o">=</span> <span class="n">get_open_msa_slits</span><span class="p">(</span><span class="n">msa_metadata_file</span><span class="p">,</span> <span class="n">msa_metadata_id</span><span class="p">,</span> <span class="n">dither_point</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exp_type</span> <span class="o">==</span> <span class="s2">&quot;nrs_fixedslit&quot;</span><span class="p">:</span>
        <span class="n">slits</span> <span class="o">=</span> <span class="n">get_open_fixed_slits</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exp_type</span> <span class="o">==</span> <span class="s2">&quot;nrs_brightobj&quot;</span><span class="p">:</span>
        <span class="n">slits</span> <span class="o">=</span> <span class="p">[</span><span class="n">Slit</span><span class="p">(</span><span class="s1">&#39;S1600A1&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slit_y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">exp_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nrs_lamp&quot;</span><span class="p">,</span> <span class="s2">&quot;nrs_autowave&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">lamp_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fixedslit&#39;</span><span class="p">,</span> <span class="s1">&#39;brightobj&#39;</span><span class="p">]:</span>
            <span class="n">slits</span> <span class="o">=</span> <span class="n">get_open_fixed_slits</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EXP_TYPE </span><span class="si">{0}</span><span class="s2"> is not supported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">reference_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slits</span> <span class="o">=</span> <span class="n">validate_open_slits</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">slits</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Slits projected on detector </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span><span class="p">,</span>
                                                               <span class="p">[</span><span class="n">sl</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">slits</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">slits</span><span class="p">:</span>
        <span class="n">log_message</span> <span class="o">=</span> <span class="s2">&quot;No open slits fall on detector </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">NoDataOnDetectorError</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">slits</span>


<span class="k">def</span> <span class="nf">get_open_fixed_slits</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="o">=</span><span class="p">[</span><span class="o">-.</span><span class="mi">55</span><span class="p">,</span> <span class="o">.</span><span class="mi">55</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; Return the opened fixed slits.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">subarray</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input file is missing SUBARRAY value/keyword.&quot;</span><span class="p">)</span>

    <span class="n">slits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span> <span class="o">=</span> <span class="n">slit_y_range</span>

    <span class="n">s2a1</span> <span class="o">=</span> <span class="n">Slit</span><span class="p">(</span><span class="s1">&#39;S200A1&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">s2a2</span> <span class="o">=</span> <span class="n">Slit</span><span class="p">(</span><span class="s1">&#39;S200A2&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">s4a1</span> <span class="o">=</span> <span class="n">Slit</span><span class="p">(</span><span class="s1">&#39;S400A1&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">s16a1</span> <span class="o">=</span> <span class="n">Slit</span><span class="p">(</span><span class="s1">&#39;S1600A1&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">s2b1</span> <span class="o">=</span> <span class="n">Slit</span><span class="p">(</span><span class="s1">&#39;S200B1&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">subarray</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">subarray</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">subarray</span> <span class="o">==</span> <span class="s2">&quot;SUBS200A1&quot;</span><span class="p">:</span>
        <span class="n">slits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s2a1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">subarray</span> <span class="o">==</span> <span class="s2">&quot;SUBS200A2&quot;</span><span class="p">:</span>
        <span class="n">slits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s2a2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">subarray</span> <span class="o">==</span> <span class="s2">&quot;SUBS400A1&quot;</span><span class="p">:</span>
        <span class="n">slits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s4a1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">subarray</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SUB2048&quot;</span><span class="p">,</span> <span class="s2">&quot;SUB512&quot;</span><span class="p">,</span> <span class="s2">&quot;SUB512S&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;SUB1024A&quot;</span><span class="p">,</span> <span class="s2">&quot;SUB1024B&quot;</span><span class="p">):</span>
        <span class="n">slits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s16a1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">subarray</span> <span class="o">==</span> <span class="s2">&quot;SUBS200B1&quot;</span><span class="p">:</span>
        <span class="n">slits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s2b1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slits</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">s2a1</span><span class="p">,</span> <span class="n">s2a2</span><span class="p">,</span> <span class="n">s4a1</span><span class="p">,</span> <span class="n">s16a1</span><span class="p">,</span> <span class="n">s2b1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">slits</span>


<span class="k">def</span> <span class="nf">get_msa_metadata</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the MSA metadata file (MSAMTFL) and the msa metadata ID (MSAMETID).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msa_config</span> <span class="o">=</span> <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;msametafile&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MSA metadata file not in reference files dict&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting MSA metadata file from MSAMETFL keyword&#39;</span><span class="p">)</span>
        <span class="n">msa_config</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">msa_metadata_file</span>
        <span class="k">if</span> <span class="n">msa_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;msa_metadata_file is None.&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">MSAFileError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">msa_metadata_id</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">msa_metadata_id</span>
    <span class="k">if</span> <span class="n">msa_metadata_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Missing msa_metadata_id (keyword MSAMETID).&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">MSAFileError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">dither_position</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">dither</span><span class="o">.</span><span class="n">position_number</span>
    <span class="k">if</span> <span class="n">dither_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Missing dither pattern number (keyword PATT_NUM).&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">MSAFileError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">msa_config</span><span class="p">,</span> <span class="n">msa_metadata_id</span><span class="p">,</span> <span class="n">dither_position</span>


<span class="k">def</span> <span class="nf">_get_bkg_source_id</span><span class="p">(</span><span class="n">bkg_counter</span><span class="p">,</span> <span class="n">shift_by</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a ``source_id`` for background slitlets.</span>

<span class="sd">    All background slitlets are assigned a source_id of 0.</span>
<span class="sd">    A unique ``source_id`` is necessary to keep them separate in exp_to_source.</span>
<span class="sd">    A counter is used to assign a unique ``source_id`` that&#39;s</span>
<span class="sd">    greater than the max ID number of all defined sources.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bkg_counter : int</span>
<span class="sd">        The current value of the counter.</span>
<span class="sd">    shift_by : int</span>
<span class="sd">        The highest of all source_id values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">bkg_counter</span> <span class="o">+</span> <span class="n">shift_by</span>


<span class="k">def</span> <span class="nf">get_open_msa_slits</span><span class="p">(</span><span class="n">msa_file</span><span class="p">,</span> <span class="n">msa_metadata_id</span><span class="p">,</span> <span class="n">dither_position</span><span class="p">,</span>
                       <span class="n">slit_y_range</span><span class="o">=</span><span class="p">[</span><span class="o">-.</span><span class="mi">55</span><span class="p">,</span> <span class="o">.</span><span class="mi">55</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the opened MOS slitlets.</span>

<span class="sd">    Computes (ymin, ymax) for each open slitlet.</span>

<span class="sd">    The msa_file is expected to contain data (tuples) with the following fields:</span>

<span class="sd">        (&#39;slitlet_id&#39;, &#39;&gt;i2&#39;),</span>
<span class="sd">        (&#39;msa_metadata_id&#39;, &#39;&gt;i2&#39;),</span>
<span class="sd">        (&#39;shutter_quadrant&#39;, &#39;&gt;i2&#39;),</span>
<span class="sd">        (&#39;shutter_row&#39;, &#39;&gt;i2&#39;),</span>
<span class="sd">        (&#39;shutter_column&#39;, &#39;&gt;i2&#39;),</span>
<span class="sd">        (&#39;source_id&#39;, &#39;&gt;i2&#39;),</span>
<span class="sd">        (&#39;background&#39;, &#39;S1&#39;),</span>
<span class="sd">        (&#39;shutter_state&#39;, &#39;S6&#39;),</span>
<span class="sd">        (&#39;estimated_source_in_shutter_x&#39;, &#39;&gt;f4&#39;),</span>
<span class="sd">        (&#39;estimated_source_in_shutter_y&#39;, &#39;&gt;f4&#39;),</span>
<span class="sd">        (&#39;dither_point_index&#39;, &#39;&gt;i2&#39;),</span>
<span class="sd">        (&#39;primary_source&#39;, &#39;S1&#39;)</span>

<span class="sd">    For example, something like:</span>
<span class="sd">        (12, 2, 4, 251, 22, 1, &#39;Y&#39;, &#39;OPEN&#39;, nan, nan, 1, &#39;N&#39;),</span>

<span class="sd">       column</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msa_file : str</span>
<span class="sd">        MSA meta data file name, FITS keyword ``MSAMETFL``.</span>
<span class="sd">    msa_metadata_id : int</span>
<span class="sd">        The MSA meta id for the science file, FITS keyword ``MSAMETID``.</span>
<span class="sd">    dither_position : int</span>
<span class="sd">        The index in the dither pattern, FITS keyword ``PATT_NUM``.</span>
<span class="sd">    slit_y_range : list or tuple of size 2</span>
<span class="sd">        The lower and upper limit of the slit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slitlets : list</span>
<span class="sd">        A list of `~jwst.transforms.models.Slit` objects. Each slitlet is a tuple with</span>
<span class="sd">        (&quot;name&quot;, &quot;shutter_id&quot;, &quot;xcen&quot;, &quot;ycen&quot;, &quot;ymin&quot;, &quot;ymax&quot;,</span>
<span class="sd">        &quot;quadrant&quot;, &quot;source_id&quot;, &quot;shutter_state&quot;, &quot;source_name&quot;, &quot;source_alias&quot;, &quot;stellarity&quot;,</span>
<span class="sd">        &quot;source_xpos&quot;, &quot;source_ypos&quot;, &quot;source_ra&quot;, &quot;source_dec&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">slitlets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span> <span class="o">=</span> <span class="n">slit_y_range</span>
    <span class="c1"># If they passed in a string then we shall assume it is the filename</span>
    <span class="c1"># of the configuration file.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msa_file</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msa_file</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Missing MSA meta (MSAMETFL) file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msa_file</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">MSAFileError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Unable to read MSA FITS file (MSAMETFL) </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msa_file</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">MSAFileError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Problem reading MSA metafile (MSAMETFL) </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msa_file</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">MSAFileError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># Get the configuration header from teh _msa.fits file.  The EXTNAME should be &#39;SHUTTER_INFO&#39;</span>
    <span class="n">msa_conf</span> <span class="o">=</span> <span class="n">msa_file</span><span class="p">[(</span><span class="s1">&#39;SHUTTER_INFO&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">msa_source</span> <span class="o">=</span> <span class="n">msa_file</span><span class="p">[(</span><span class="s2">&quot;SOURCE_INFO&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># First we are going to filter the msa_file data on the msa_metadata_id</span>
    <span class="c1"># and dither_point_index.</span>
    <span class="n">msa_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">msa_conf</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;msa_metadata_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">msa_metadata_id</span> \
                <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;dither_point_index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dither_position</span><span class="p">]</span>

    <span class="c1"># Get all source_ids for slitlets with sources.</span>
    <span class="c1"># These should not be used when assigning source_id to background slitlets.</span>
    <span class="n">source_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">msa_conf</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;msa_metadata_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">msa_metadata_id</span> \
                      <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;dither_point_index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dither_position</span><span class="p">])</span>
    <span class="c1"># All BKG shutters in the msa metafile have a source_id value of 0.</span>
    <span class="c1"># Remove it from the list of source ids.</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">source_ids</span><span class="p">:</span>
        <span class="n">source_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source_ids</span><span class="p">:</span>
        <span class="n">max_source_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">source_ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_source_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># define a counter for &quot;all background&quot; slitlets.</span>
    <span class="c1"># It will be used to assign a &quot;source_id&quot;.</span>
    <span class="n">bkg_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;msa_data with msa_metadata_id = </span><span class="si">{</span><span class="n">msa_metadata_id</span><span class="si">}</span><span class="s1">   </span><span class="si">{</span><span class="n">msa_data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Retrieving open MSA slitlets for msa_metadata_id = </span><span class="si">{</span><span class="n">msa_metadata_id</span><span class="si">}</span><span class="s1"> &#39;</span>
             <span class="sa">f</span><span class="s1">&#39;and dither_index = </span><span class="si">{</span><span class="n">dither_position</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Get the unique slitlet_ids</span>
    <span class="n">slitlet_ids_unique</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;slitlet_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">msa_data</span><span class="p">]))</span>

    <span class="c1"># SDP may assign a value of &quot;-1&quot; to ``slitlet_id`` - these need to be ignored.</span>
    <span class="c1"># JP-436</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">slitlet_ids_unique</span><span class="p">:</span>
        <span class="n">slitlet_ids_unique</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># add a margin to the slit y limits</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="mf">0.05</span>

    <span class="c1"># Now lets look at each unique slitlet id</span>
    <span class="k">for</span> <span class="n">slitlet_id</span> <span class="ow">in</span> <span class="n">slitlet_ids_unique</span><span class="p">:</span>
        <span class="c1"># Get the rows for the current slitlet_id</span>
        <span class="n">slitlets_sid</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">msa_data</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;slitlet_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">slitlet_id</span><span class="p">]</span>
        <span class="n">open_shutters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">slitlets_sid</span><span class="p">]</span>

        <span class="n">n_main_shutter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slitlets_sid</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;primary_source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">])</span>
        <span class="c1"># In the next part we need to calculate, find, determine 5 things:</span>
        <span class="c1">#    quadrant,  xcen, ycen,  ymin, ymax</span>

        <span class="c1"># There are no main shutters, all are background</span>
        <span class="k">if</span> <span class="n">n_main_shutter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">open_shutters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">jmin</span> <span class="o">=</span> <span class="n">jmax</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="n">open_shutters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slitlets_sid</span><span class="p">])</span>
                <span class="n">jmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slitlets_sid</span><span class="p">])</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">jmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">jmax</span> <span class="o">-</span> <span class="n">jmin</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">margin</span> <span class="o">+</span> <span class="p">(</span><span class="n">jmax</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.15</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">ylow</span> <span class="o">+</span> <span class="n">margin</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">jmin</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.15</span>
            <span class="n">quadrant</span> <span class="o">=</span> <span class="n">slitlets_sid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shutter_quadrant&#39;</span><span class="p">]</span>
            <span class="n">ycen</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">xcen</span> <span class="o">=</span> <span class="n">slitlets_sid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shutter_row&#39;</span><span class="p">]</span>  <span class="c1"># grab the first as they are all the same</span>
            <span class="n">source_xpos</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">source_ypos</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">source_id</span> <span class="o">=</span> <span class="n">_get_bkg_source_id</span><span class="p">(</span><span class="n">bkg_counter</span><span class="p">,</span> <span class="n">max_source_id</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Slitlet_id </span><span class="si">{</span><span class="n">slitlet_id</span><span class="si">}</span><span class="s1"> is background only; assigned source_id = </span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">bkg_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># There is 1 main shutter, phew, that makes it easier.</span>
        <span class="k">elif</span> <span class="n">n_main_shutter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">quadrant</span><span class="p">,</span> <span class="n">source_xpos</span><span class="p">,</span> <span class="n">source_ypos</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;shutter_row&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;shutter_quadrant&#39;</span><span class="p">],</span>
                 <span class="n">s</span><span class="p">[</span><span class="s1">&#39;estimated_source_in_shutter_x&#39;</span><span class="p">],</span>
                 <span class="n">s</span><span class="p">[</span><span class="s1">&#39;estimated_source_in_shutter_y&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slitlets_sid</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># y-size</span>
            <span class="n">jmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slitlets_sid</span><span class="p">])</span>
            <span class="n">jmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slitlets_sid</span><span class="p">])</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">ycen</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">yhigh</span> <span class="o">+</span> <span class="n">margin</span> <span class="o">+</span> <span class="p">(</span><span class="n">jmax</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.15</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">ylow</span> <span class="o">+</span> <span class="n">margin</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">jmin</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.15</span>
            <span class="n">source_id</span> <span class="o">=</span> <span class="n">slitlets_sid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;source_id&#39;</span><span class="p">]</span>
        <span class="c1"># Not allowed....</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For slitlet_id = </span><span class="si">{}</span><span class="s2">, metadata_id = </span><span class="si">{}</span><span class="s2">, &quot;</span>
                       <span class="s2">&quot;and dither_index = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slitlet_id</span><span class="p">,</span> <span class="n">msa_metadata_id</span><span class="p">,</span> <span class="n">dither_position</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;MSA configuration file has more than 1 shutter with primary source&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">MSAFileError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># subtract 1 because shutter numbers in the MSA reference file are 1-based.</span>
        <span class="n">shutter_id</span> <span class="o">=</span> <span class="n">xcen</span> <span class="o">+</span> <span class="p">(</span><span class="n">ycen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">365</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source_name</span><span class="p">,</span> <span class="n">source_alias</span><span class="p">,</span> <span class="n">stellarity</span><span class="p">,</span> <span class="n">source_ra</span><span class="p">,</span> <span class="n">source_dec</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;source_name&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;stellarity&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">])</span> \
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">msa_source</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">source_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># all background shutters</span>
            <span class="n">source_name</span> <span class="o">=</span> <span class="s2">&quot;background_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slitlet_id</span><span class="p">)</span>
            <span class="n">source_alias</span> <span class="o">=</span> <span class="s2">&quot;bkg_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slitlet_id</span><span class="p">)</span>
            <span class="n">stellarity</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">source_ra</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">source_dec</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Create the output list of tuples that contain the required</span>
        <span class="c1"># data for further computations</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert source positions from PPS to Model coordinate frame.</span>
<span class="sd">        The source x,y position in the shutter is given in the msa configuration file,</span>
<span class="sd">        columns &quot;estimated_source_in_shutter_x&quot; and &quot;estimated_source_in_shutter_y&quot;.</span>
<span class="sd">        The source position is in a coordinate system associated with each shutter whose</span>
<span class="sd">        origin is the lower left corner of the shutter, positive x is to the right</span>
<span class="sd">        and positive y is upwards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_xpos</span> <span class="o">-=</span> <span class="mf">0.5</span>
        <span class="n">source_ypos</span> <span class="o">-=</span> <span class="mf">0.5</span>

        <span class="c1"># Create the shutter_state string</span>
        <span class="n">all_shutters</span> <span class="o">=</span> <span class="n">_shutter_id_to_str</span><span class="p">(</span><span class="n">open_shutters</span><span class="p">,</span> <span class="n">ycen</span><span class="p">)</span>

        <span class="n">slitlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Slit</span><span class="p">(</span><span class="n">slitlet_id</span><span class="p">,</span> <span class="n">shutter_id</span><span class="p">,</span> <span class="n">dither_position</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span>
                             <span class="n">quadrant</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">all_shutters</span><span class="p">,</span> <span class="n">source_name</span><span class="p">,</span> <span class="n">source_alias</span><span class="p">,</span>
                             <span class="n">stellarity</span><span class="p">,</span> <span class="n">source_xpos</span><span class="p">,</span> <span class="n">source_ypos</span><span class="p">,</span> <span class="n">source_ra</span><span class="p">,</span> <span class="n">source_dec</span><span class="p">))</span>
    <span class="n">msa_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">slitlets</span>


<span class="k">def</span> <span class="nf">_shutter_id_to_str</span><span class="p">(</span><span class="n">open_shutters</span><span class="p">,</span> <span class="n">ycen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a string representing the open and closed shutters in a slitlet.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    open_shutters : list</span>
<span class="sd">        List of IDs (shutter_id) of open shutters.</span>
<span class="sd">    xcen : int</span>
<span class="sd">        X coordinate of main shutter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    all_shutters : str</span>
<span class="sd">        String representing the state of the shutters.</span>
<span class="sd">        &quot;1&quot; indicates an open shutter, &quot;0&quot; - a closed one, and</span>
<span class="sd">        &quot;x&quot; - the main shutter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_shutters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">open_shutters</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">open_shutters</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">cen_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_shutters</span> <span class="o">==</span> <span class="n">ycen</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">open_shutters</span><span class="p">:</span>
        <span class="n">all_shutters</span><span class="p">[</span><span class="n">all_shutters</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">all_shutters</span><span class="p">[</span><span class="n">all_shutters</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_shutters</span> <span class="o">=</span> <span class="n">all_shutters</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">str</span><span class="p">)</span>
    <span class="n">all_shutters</span><span class="p">[</span><span class="n">cen_ind</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_shutters</span><span class="p">)</span>


<div class="viewcode-block" id="get_spectral_order_wrange"><a class="viewcode-back" href="../../../api/jwst.assign_wcs.get_spectral_order_wrange.html#jwst.assign_wcs.get_spectral_order_wrange">[docs]</a><span class="k">def</span> <span class="nf">get_spectral_order_wrange</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">wavelengthrange_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the spectral order and wavelength range from the reference file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : `~jwst.datamodels.DataModel`</span>
<span class="sd">        The input data model.</span>
<span class="sd">    wavelengthrange_file : str</span>
<span class="sd">        Reference file of type &quot;wavelengthrange&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Nirspec full spectral range</span>
    <span class="n">full_range</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="mf">6e-6</span><span class="p">,</span> <span class="mf">5.3e-6</span><span class="p">]</span>

    <span class="nb">filter</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span>
    <span class="n">lamp</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">lamp_state</span>
    <span class="n">grating</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">grating</span>
    <span class="n">exp_type</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">type</span>

    <span class="n">is_lamp_exposure</span> <span class="o">=</span> <span class="n">exp_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NRS_LAMP&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_AUTOWAVE&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_AUTOFLAT&#39;</span><span class="p">]</span>

    <span class="n">wave_range_model</span> <span class="o">=</span> <span class="n">WavelengthrangeModel</span><span class="p">(</span><span class="n">wavelengthrange_file</span><span class="p">)</span>
    <span class="n">wrange_selector</span> <span class="o">=</span> <span class="n">wave_range_model</span><span class="o">.</span><span class="n">waverange_selector</span>
    <span class="k">if</span> <span class="nb">filter</span> <span class="o">==</span> <span class="s2">&quot;OPAQUE&quot;</span> <span class="ow">or</span> <span class="n">is_lamp_exposure</span><span class="p">:</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="n">lamp</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">grating</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="nb">filter</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">grating</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">wrange_selector</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="c1"># Combination of filter_grating is not in wavelengthrange file.</span>
        <span class="n">gratings</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wrange_selector</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">gratings</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">grating</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># grating not in list</span>
            <span class="n">order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">wrange</span> <span class="o">=</span> <span class="n">full_range</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">wave_range_model</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">wrange</span> <span class="o">=</span> <span class="n">wave_range_model</span><span class="o">.</span><span class="n">wavelengthrange</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Combination </span><span class="si">{0}</span><span class="s2"> missing in wavelengthrange file, setting &quot;</span>
                 <span class="s2">&quot;order to </span><span class="si">{1}</span><span class="s2"> and range to </span><span class="si">{2}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">wrange</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Combination of filter_grating is found in wavelengthrange file.</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">wave_range_model</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">wrange</span> <span class="o">=</span> <span class="n">wave_range_model</span><span class="o">.</span><span class="n">wavelengthrange</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="n">wave_range_model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">order</span><span class="p">,</span> <span class="n">wrange</span></div>


<span class="k">def</span> <span class="nf">ifuslit_to_slicer</span><span class="p">(</span><span class="n">slits</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">input_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The transform from ``slit_frame`` to ``slicer`` frame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    slits : list</span>
<span class="sd">        A list of slit IDs for all slices.</span>
<span class="sd">    reference_files : dict</span>
<span class="sd">        {reference_type: reference_file_name}</span>
<span class="sd">    input_model : `~jwst.datamodels.IFUImageModel`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~jwst.transforms.Slit2Msa` model.</span>
<span class="sd">        Transform from ``slit_frame`` to ``slicer`` frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ifuslicer</span> <span class="o">=</span> <span class="n">IFUSlicerModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;ifuslicer&#39;</span><span class="p">])</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ifuslicer_model</span> <span class="o">=</span> <span class="n">ifuslicer</span><span class="o">.</span><span class="n">model</span>
    <span class="k">for</span> <span class="n">slit</span> <span class="ow">in</span> <span class="n">slits</span><span class="p">:</span>
        <span class="n">slitdata</span> <span class="o">=</span> <span class="n">ifuslicer</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">slit</span><span class="p">]</span>
        <span class="n">slitdata_model</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_slit_location_model</span><span class="p">(</span><span class="n">slitdata</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;slitdata_model&#39;</span><span class="p">)</span>
        <span class="n">slicer_model</span> <span class="o">=</span> <span class="n">slitdata_model</span> <span class="o">|</span> <span class="n">ifuslicer_model</span>

        <span class="n">msa_transform</span> <span class="o">=</span> <span class="n">slicer_model</span>
        <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msa_transform</span><span class="p">)</span>
    <span class="n">ifuslicer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">Slit2Msa</span><span class="p">(</span><span class="n">slits</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">slicer_to_msa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trasform from slicer coordinates to MSA entrance.</span>

<span class="sd">    Applies the IFUFORE transform.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">IFUFOREModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;ifufore&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">ifufore</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">model</span>
    <span class="n">slicer2fore_mapping</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">slicer2fore_mapping</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ifufore2fore_mapping</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ifufore2fore_mapping</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">ifu_fore_transform</span> <span class="o">=</span> <span class="n">slicer2fore_mapping</span> <span class="o">|</span> <span class="n">ifufore</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ifu_fore_transform</span>


<span class="k">def</span> <span class="nf">slit_to_msa</span><span class="p">(</span><span class="n">open_slits</span><span class="p">,</span> <span class="n">msafile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The transform from ``slit_frame`` to ``msa_frame``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    open_slits : list</span>
<span class="sd">        A list of slit IDs for all open shutters/slitlets.</span>
<span class="sd">    msafile : str</span>
<span class="sd">        The name of the msa reference file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~jwst.transforms.Slit2Msa` model.</span>
<span class="sd">        Transform from ``slit_frame`` to ``msa_frame``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msa</span> <span class="o">=</span> <span class="n">MSAModel</span><span class="p">(</span><span class="n">msafile</span><span class="p">)</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">slits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">quadrant</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">slits_in_quadrant</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">open_slits</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">quadrant</span> <span class="o">==</span> <span class="n">quadrant</span><span class="p">]</span>
        <span class="n">msa_quadrant</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">msa</span><span class="p">,</span> <span class="s1">&#39;Q</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quadrant</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">slits_in_quadrant</span><span class="p">):</span>
            <span class="n">msa_data</span> <span class="o">=</span> <span class="n">msa_quadrant</span><span class="o">.</span><span class="n">data</span>
            <span class="n">msa_model</span> <span class="o">=</span> <span class="n">msa_quadrant</span><span class="o">.</span><span class="n">model</span>
            <span class="k">for</span> <span class="n">slit</span> <span class="ow">in</span> <span class="n">slits_in_quadrant</span><span class="p">:</span>
                <span class="n">slit_id</span> <span class="o">=</span> <span class="n">slit</span><span class="o">.</span><span class="n">shutter_id</span>
                <span class="c1"># Shutters are numbered starting from 1.</span>
                <span class="c1"># Fixed slits (Quadrant 5) are mapped starting from 0.</span>
                <span class="k">if</span> <span class="n">quadrant</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">slit_id</span> <span class="o">=</span> <span class="n">slit_id</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">slitdata</span> <span class="o">=</span> <span class="n">msa_data</span><span class="p">[</span><span class="n">slit_id</span><span class="p">]</span>
                <span class="n">slitdata_model</span> <span class="o">=</span> <span class="n">get_slit_location_model</span><span class="p">(</span><span class="n">slitdata</span><span class="p">)</span>
                <span class="n">msa_transform</span> <span class="o">=</span> <span class="n">slitdata_model</span> <span class="o">|</span> <span class="n">msa_model</span>
                <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msa_transform</span><span class="p">)</span>
                <span class="n">slits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slit</span><span class="p">)</span>
    <span class="n">msa</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Slit2Msa</span><span class="p">(</span><span class="n">slits</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gwa_to_ifuslit</span><span class="p">(</span><span class="n">slits</span><span class="p">,</span> <span class="n">input_model</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The transform from ``gwa`` to ``slit_frame``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    slits : list</span>
<span class="sd">        A list of slit IDs for all IFU slits 0-29.</span>
<span class="sd">    disperser : `~jwst.datamodels.DisperserModel`</span>
<span class="sd">        A disperser model with the GWA correction applied to it.</span>
<span class="sd">    filter : str</span>
<span class="sd">        The filter used.</span>
<span class="sd">    grating : str</span>
<span class="sd">        The grating used in the observation.</span>
<span class="sd">    reference_files: dict</span>
<span class="sd">        Dictionary with reference files returned by CRDS.</span>
<span class="sd">    slit_y_range : list or tuple of size 2</span>
<span class="sd">        The lower and upper bounds of a slit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~jwst.transforms.Gwa2Slit` model.</span>
<span class="sd">        Transform from ``gwa`` frame to ``slit_frame``.</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">slit_y_range</span>

    <span class="n">agreq</span> <span class="o">=</span> <span class="n">angle_from_disperser</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">input_model</span><span class="p">)</span>
    <span class="n">lgreq</span> <span class="o">=</span> <span class="n">wavelength_from_disperser</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">input_model</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">velosys</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">velosys</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">velosys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">velocity_corr</span> <span class="o">=</span> <span class="n">velocity_correction</span><span class="p">(</span><span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">velosys</span><span class="p">)</span>
            <span class="n">lgreq</span> <span class="o">=</span> <span class="n">lgreq</span> <span class="o">|</span> <span class="n">velocity_corr</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applied Barycentric velocity correction : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">velocity_corr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="c1"># The wavelength units up to this point are</span>
    <span class="c1"># meters as required by the pipeline but the desired output wavelength units is microns.</span>
    <span class="c1"># So we are going to Scale the spectral units by 1e6 (meters -&gt; microns)</span>
    <span class="n">is_lamp_exposure</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NRS_LAMP&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_AUTOWAVE&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_AUTOFLAT&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span> <span class="o">==</span> <span class="s1">&#39;OPAQUE&#39;</span> <span class="ow">or</span> <span class="n">is_lamp_exposure</span><span class="p">:</span>
        <span class="n">lgreq</span> <span class="o">=</span> <span class="n">lgreq</span> <span class="o">|</span> <span class="n">Scale</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>

    <span class="n">lam_cen</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_end</span> <span class="o">-</span>
                     <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_start</span>
                     <span class="p">)</span> <span class="o">+</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_start</span>
    <span class="n">collimator2gwa</span> <span class="o">=</span> <span class="n">collimator_to_gwa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span> <span class="n">disperser</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_slit</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>

    <span class="n">ifuslicer</span> <span class="o">=</span> <span class="n">IFUSlicerModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;ifuslicer&#39;</span><span class="p">])</span>
    <span class="n">ifupost</span> <span class="o">=</span> <span class="n">IFUPostModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;ifupost&#39;</span><span class="p">])</span>
    <span class="n">slit_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ifuslicer_model</span> <span class="o">=</span> <span class="n">ifuslicer</span><span class="o">.</span><span class="n">model</span>
    <span class="k">for</span> <span class="n">slit</span> <span class="ow">in</span> <span class="n">slits</span><span class="p">:</span>
        <span class="n">slitdata</span> <span class="o">=</span> <span class="n">ifuslicer</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">slit</span><span class="p">]</span>
        <span class="n">slitdata_model</span> <span class="o">=</span> <span class="n">get_slit_location_model</span><span class="p">(</span><span class="n">slitdata</span><span class="p">)</span>
        <span class="n">ifuslicer_transform</span> <span class="o">=</span> <span class="p">(</span><span class="n">slitdata_model</span> <span class="o">|</span> <span class="n">ifuslicer_model</span><span class="p">)</span>
        <span class="n">ifupost_sl</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ifupost</span><span class="p">,</span> <span class="s2">&quot;slice_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slit</span><span class="p">))</span>
        <span class="c1"># construct IFU post transform</span>
        <span class="n">ifupost_transform</span> <span class="o">=</span> <span class="n">_create_ifupost_transform</span><span class="p">(</span><span class="n">ifupost_sl</span><span class="p">)</span>
        <span class="n">msa2gwa</span> <span class="o">=</span> <span class="n">ifuslicer_transform</span> <span class="o">&amp;</span> <span class="n">Const1D</span><span class="p">(</span><span class="n">lam_cen</span><span class="p">)</span> <span class="o">|</span> <span class="n">ifupost_transform</span> <span class="o">|</span> <span class="n">collimator2gwa</span>
        <span class="n">gwa2slit</span> <span class="o">=</span> <span class="n">gwa_to_ymsa</span><span class="p">(</span><span class="n">msa2gwa</span><span class="p">,</span> <span class="n">lam_cen</span><span class="o">=</span><span class="n">lam_cen</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="o">=</span><span class="n">slit_y_range</span><span class="p">)</span><span class="c1"># TODO: Use model sets here</span>

        <span class="c1"># The commnts below list the input coordinates.</span>
        <span class="n">bgwa2msa</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># (alpha_out, beta_out, gamma_out), angles at the GWA, coming from the camera</span>
            <span class="c1"># (0, - beta_out, alpha_out, beta_out)</span>
            <span class="c1"># (0, sy, alpha_out, beta_out)</span>
            <span class="c1"># (0, sy, 0, sy, sy, alpha_out, beta_out)</span>
            <span class="c1"># ( 0, sy, alpha_in, beta_in, gamma_in, alpha_out, beta_out)</span>
            <span class="c1"># (0, sy, alpha_in, beta_in,alpha_out)</span>
            <span class="c1"># (0, sy, lambda_computed)</span>
            <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
            <span class="n">Const1D</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Const1D</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> \
            <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">gwa2slit</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> \
            <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> \
            <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">msa2gwa</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> \
            <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> \
            <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">lgreq</span> <span class="o">|</span> <span class="n">mask</span>
        <span class="p">)</span>

        <span class="c1"># transform from ``msa_frame`` to ``gwa`` frame (before the GWA going from detector to sky).</span>
        <span class="n">msa2gwa_out</span> <span class="o">=</span> <span class="n">ifuslicer_transform</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">ifupost_transform</span> <span class="o">|</span> <span class="n">collimator2gwa</span>
        <span class="n">msa2bgwa</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">|</span> <span class="n">msa2gwa_out</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">|</span> <span class="n">agreq</span>
        <span class="n">bgwa2msa</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">msa2bgwa</span>
        <span class="n">slit_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bgwa2msa</span><span class="p">)</span>

    <span class="n">ifuslicer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">ifupost</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Gwa2Slit</span><span class="p">(</span><span class="n">slits</span><span class="p">,</span> <span class="n">slit_models</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gwa_to_slit</span><span class="p">(</span><span class="n">open_slits</span><span class="p">,</span> <span class="n">input_model</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span>
                <span class="n">reference_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The transform from ``gwa`` to ``slit_frame``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    open_slits : list</span>
<span class="sd">        A list of slit IDs for all open shutters/slitlets.</span>
<span class="sd">    disperser : dict</span>
<span class="sd">        A corrected disperser ASDF object.</span>
<span class="sd">    filter : str</span>
<span class="sd">        The filter used.</span>
<span class="sd">    grating : str</span>
<span class="sd">        The grating used in the observation.</span>
<span class="sd">    reference_files: dict</span>
<span class="sd">        Dictionary with reference files returned by CRDS.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~jwst.transforms.Gwa2Slit` model.</span>
<span class="sd">        Transform from ``gwa`` frame to ``slit_frame``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">agreq</span> <span class="o">=</span> <span class="n">angle_from_disperser</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">input_model</span><span class="p">)</span>
    <span class="n">collimator2gwa</span> <span class="o">=</span> <span class="n">collimator_to_gwa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span> <span class="n">disperser</span><span class="p">)</span>
    <span class="n">lgreq</span> <span class="o">=</span> <span class="n">wavelength_from_disperser</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">input_model</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">velosys</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">velosys</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">velosys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">velocity_corr</span> <span class="o">=</span> <span class="n">velocity_correction</span><span class="p">(</span><span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">velosys</span><span class="p">)</span>
            <span class="n">lgreq</span> <span class="o">=</span> <span class="n">lgreq</span> <span class="o">|</span> <span class="n">velocity_corr</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applied Barycentric velocity correction : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">velocity_corr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

    <span class="c1"># The wavelength units up to this point are</span>
    <span class="c1"># meters as required by the pipeline but the desired output wavelength units is microns.</span>
    <span class="c1"># So we are going to Scale the spectral units by 1e6 (meters -&gt; microns)</span>
    <span class="k">if</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span> <span class="o">==</span> <span class="s1">&#39;OPAQUE&#39;</span><span class="p">:</span>
        <span class="n">lgreq</span> <span class="o">=</span> <span class="n">lgreq</span> <span class="o">|</span> <span class="n">Scale</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>

    <span class="n">msa</span> <span class="o">=</span> <span class="n">MSAModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;msa&#39;</span><span class="p">])</span>
    <span class="n">slit_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">slits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">quadrant</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">slits_in_quadrant</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">open_slits</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">quadrant</span> <span class="o">==</span> <span class="n">quadrant</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">{0}</span><span class="s2"> open slits in quadrant </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slits_in_quadrant</span><span class="p">),</span> <span class="n">quadrant</span><span class="p">))</span>
        <span class="n">msa_quadrant</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">msa</span><span class="p">,</span> <span class="s1">&#39;Q</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quadrant</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">slits_in_quadrant</span><span class="p">):</span>
            <span class="n">msa_model</span> <span class="o">=</span> <span class="n">msa_quadrant</span><span class="o">.</span><span class="n">model</span>
            <span class="n">msa_data</span> <span class="o">=</span> <span class="n">msa_quadrant</span><span class="o">.</span><span class="n">data</span>

            <span class="k">for</span> <span class="n">slit</span> <span class="ow">in</span> <span class="n">slits_in_quadrant</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_slit</span><span class="p">(</span><span class="n">slit</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">slit</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>
                <span class="n">slit_id</span> <span class="o">=</span> <span class="n">slit</span><span class="o">.</span><span class="n">shutter_id</span>
                <span class="c1"># Shutter IDs are numbered starting from 1</span>
                <span class="c1"># while FS are numbered starting from 0.</span>
                <span class="c1"># &quot;Quadrant 5 is for fixed slits.</span>
                <span class="k">if</span> <span class="n">quadrant</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">slit_id</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">slitdata</span> <span class="o">=</span> <span class="n">msa_data</span><span class="p">[</span><span class="n">slit_id</span><span class="p">]</span>
                <span class="n">slitdata_model</span> <span class="o">=</span> <span class="n">get_slit_location_model</span><span class="p">(</span><span class="n">slitdata</span><span class="p">)</span>
                <span class="n">msa_transform</span> <span class="o">=</span> <span class="p">(</span><span class="n">slitdata_model</span> <span class="o">|</span> <span class="n">msa_model</span><span class="p">)</span>
                <span class="n">msa2gwa</span> <span class="o">=</span> <span class="p">(</span><span class="n">msa_transform</span> <span class="o">|</span> <span class="n">collimator2gwa</span><span class="p">)</span>
                <span class="n">gwa2msa</span> <span class="o">=</span> <span class="n">gwa_to_ymsa</span><span class="p">(</span><span class="n">msa2gwa</span><span class="p">,</span> <span class="n">slit</span><span class="o">=</span><span class="n">slit</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="o">=</span><span class="p">(</span><span class="n">slit</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">slit</span><span class="o">.</span><span class="n">ymax</span><span class="p">))</span><span class="c1"># TODO: Use model sets here</span>
                <span class="n">bgwa2msa</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="n">Const1D</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Const1D</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">gwa2msa</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">msa2gwa</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">lgreq</span> <span class="o">|</span> <span class="n">mask</span>
                    <span class="c1">#Mapping((0, 1, 2, 5), n_inputs=7) | Identity(2) &amp; lgreq | mask</span>
                    <span class="c1"># and modify lgreq to accept alpha_in, beta_in, alpha_out</span>
                <span class="c1"># msa to before_gwa</span>
                <span class="n">msa2bgwa</span> <span class="o">=</span> <span class="n">msa2gwa</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">|</span> <span class="n">agreq</span>
                <span class="n">bgwa2msa</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">msa2bgwa</span>
                <span class="n">slit_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bgwa2msa</span><span class="p">)</span>
                <span class="n">slits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slit</span><span class="p">)</span>
    <span class="n">msa</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Gwa2Slit</span><span class="p">(</span><span class="n">slits</span><span class="p">,</span> <span class="n">slit_models</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">angle_from_disperser</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">input_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For gratings this returns a form of the grating equation</span>
<span class="sd">    which computes the angle when lambda is known.</span>

<span class="sd">    For prism data this returns the Snell model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sporder</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">spectral_order</span>
    <span class="k">if</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">grating</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;prism&#39;</span><span class="p">:</span>
        <span class="n">agreq</span> <span class="o">=</span> <span class="n">AngleFromGratingEquation</span><span class="p">(</span><span class="n">disperser</span><span class="o">.</span><span class="n">groovedensity</span><span class="p">,</span>
                                         <span class="n">sporder</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;alpha_from_greq&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">agreq</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">system_temperature</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">gwa_tilt</span>
        <span class="n">system_pressure</span> <span class="o">=</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;pref&#39;</span><span class="p">]</span>

        <span class="n">snell</span> <span class="o">=</span> <span class="n">Snell</span><span class="p">(</span><span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;kcoef&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;lcoef&#39;</span><span class="p">],</span>
                      <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;tcoef&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;tref&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;pref&#39;</span><span class="p">],</span>
                      <span class="n">system_temperature</span><span class="p">,</span> <span class="n">system_pressure</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;snell_law&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">snell</span>


<span class="k">def</span> <span class="nf">wavelength_from_disperser</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">input_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For gratings this returns a form of the grating equation</span>
<span class="sd">    which computes lambda when all angles are known.</span>

<span class="sd">    For prism data this returns a lookup table model</span>
<span class="sd">    computing lambda from a known refraction index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sporder</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">spectral_order</span>
    <span class="k">if</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">grating</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;prism&#39;</span><span class="p">:</span>
        <span class="n">lgreq</span> <span class="o">=</span> <span class="n">WavelengthFromGratingEquation</span><span class="p">(</span><span class="n">disperser</span><span class="o">.</span><span class="n">groovedensity</span><span class="p">,</span>
                                              <span class="n">sporder</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lambda_from_gratingeq&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lgreq</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">6.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>
        <span class="n">system_temperature</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">gwa_tilt</span>
        <span class="k">if</span> <span class="n">system_temperature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Missing reference temperature (keyword GWA_TILT).&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">system_pressure</span> <span class="o">=</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;pref&#39;</span><span class="p">]</span>
        <span class="n">tref</span> <span class="o">=</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;tref&#39;</span><span class="p">]</span>
        <span class="n">pref</span> <span class="o">=</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;pref&#39;</span><span class="p">]</span>
        <span class="n">kcoef</span> <span class="o">=</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;kcoef&#39;</span><span class="p">][:]</span>
        <span class="n">lcoef</span> <span class="o">=</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;lcoef&#39;</span><span class="p">][:]</span>
        <span class="n">tcoef</span> <span class="o">=</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;tcoef&#39;</span><span class="p">][:]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">Snell</span><span class="o">.</span><span class="n">compute_refraction_index</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">system_temperature</span><span class="p">,</span> <span class="n">tref</span><span class="p">,</span> <span class="n">pref</span><span class="p">,</span>
                                           <span class="n">system_pressure</span><span class="p">,</span> <span class="n">kcoef</span><span class="p">,</span> <span class="n">lcoef</span><span class="p">,</span> <span class="n">tcoef</span>
                                           <span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
        <span class="n">n_from_prism</span> <span class="o">=</span> <span class="n">RefractionIndexFromPrism</span><span class="p">(</span><span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;n_prism&#39;</span><span class="p">)</span>

        <span class="n">tab</span> <span class="o">=</span> <span class="n">Tabular1D</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,),</span> <span class="n">lookup_table</span><span class="o">=</span><span class="n">lam</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n_from_prism</span> <span class="o">|</span> <span class="n">tab</span>


<span class="k">def</span> <span class="nf">detector_to_gwa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span> <span class="n">detector</span><span class="p">,</span> <span class="n">disperser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform from ``sca`` frame to ``gwa`` frame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reference_files: dict</span>
<span class="sd">        Dictionary with reference files returned by CRDS.</span>
<span class="sd">    detector : str</span>
<span class="sd">        The detector keyword.</span>
<span class="sd">    disperser : dict</span>
<span class="sd">        A corrected disperser ASDF object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~astropy.modeling.core.Model` model.</span>
<span class="sd">        Transform from DETECTOR frame to GWA frame.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">FPAModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;fpa&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">fpa</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">detector</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_model&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">CameraModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;camera&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">model</span>

    <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;theta_x&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;theta_y&#39;</span><span class="p">],</span>
               <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;theta_z&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;tilt_y&#39;</span><span class="p">]]</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="n">Rotation3DToGWA</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;xyzy&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span>
    <span class="n">u2dircos</span> <span class="o">=</span> <span class="n">Unitless2DirCos</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;unitless2directional_cosines&#39;</span><span class="p">)</span>
    <span class="c1">## NIRSPEC 1- vs 0- based pixel coordinates issue #1781</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The pipeline works with 0-based pixel coordinates. The Nirspec model,</span>
<span class="sd">    stored in reference files, is also 0-based. However, the algorithm specified</span>
<span class="sd">    by the IDT team specifies that pixel coordinates are 1-based. This is</span>
<span class="sd">    implemented below as a Shift(-1) &amp; Shift(-1) transform. This makes the Nirspec</span>
<span class="sd">    instrument WCS pipeline &quot;special&quot; as it requires 1-based inputs.</span>
<span class="sd">    As a consequence many steps have to be modified to provide 1-based coordinates</span>
<span class="sd">    to the WCS call if the instrument is Nirspec. This is not always easy, especially</span>
<span class="sd">    when the step has no knowledge of the instrument.</span>
<span class="sd">    This is the reason the algorithm is modified to acccept 0-based coordinates.</span>
<span class="sd">    This will be discussed in the future with the INS and IDT teams and may be solved</span>
<span class="sd">    by changing the algorithm but for now</span>

<span class="sd">    model = (models.Shift(-1) &amp; models.Shift(-1) | fpa | camera | u2dircos | rotation)</span>

<span class="sd">    is changed to</span>

<span class="sd">    model = models.Shift(1) &amp; models.Shift(1) | \</span>
<span class="sd">            models.Shift(-1) &amp; models.Shift(-1) | fpa | camera | u2dircos | rotation</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">fpa</span> <span class="o">|</span> <span class="n">camera</span> <span class="o">|</span> <span class="n">u2dircos</span> <span class="o">|</span> <span class="n">rotation</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">dms_to_sca</span><span class="p">(</span><span class="n">input_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms from ``detector`` to ``sca`` coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span>
    <span class="n">xstart</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">subarray</span><span class="o">.</span><span class="n">xstart</span>
    <span class="n">ystart</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">subarray</span><span class="o">.</span><span class="n">ystart</span>
    <span class="k">if</span> <span class="n">xstart</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xstart</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">ystart</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ystart</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># The SCA coordinates are in full frame</span>
    <span class="c1"># The inputs are 1-based, remove -1 when&#39;if they are 0-based</span>
    <span class="c1"># The outputs must be 1-based because this is what the model expects.</span>
    <span class="c1"># If xstart was 0-based and the inputs were 0-based -&gt;</span>
    <span class="c1"># Shift(+1)</span>
    <span class="n">subarray2full</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Shift</span><span class="p">(</span><span class="n">xstart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">models</span><span class="o">.</span><span class="n">Shift</span><span class="p">(</span><span class="n">ystart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">detector</span> <span class="o">==</span> <span class="s1">&#39;NRS2&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2047</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">models</span><span class="o">.</span><span class="n">Shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2047</span><span class="p">)</span> <span class="o">|</span> <span class="n">models</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">models</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">detector</span> <span class="o">==</span> <span class="s1">&#39;NRS1&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subarray2full</span> <span class="o">|</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">mask_slit</span><span class="p">(</span><span class="n">ymin</span><span class="o">=-.</span><span class="mi">55</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=.</span><span class="mi">55</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a model which masks out pixels in a NIRSpec cutout outside the slit.</span>

<span class="sd">    Uses ymin, ymax for the slit and the wavelength range to define the location of the slit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ymin, ymax : float</span>
<span class="sd">        ymin and ymax relative boundary of a slit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~astropy.modeling.core.Model`</span>
<span class="sd">        A model which takes x_slit, y_slit, lam inputs and substitutes the</span>
<span class="sd">        values outside the slit with NaN.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">greater_than_ymax</span> <span class="o">=</span> <span class="n">Logical</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;GT&#39;</span><span class="p">,</span> <span class="n">compareto</span><span class="o">=</span><span class="n">ymax</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">less_than_ymin</span> <span class="o">=</span> <span class="n">Logical</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;LT&#39;</span><span class="p">,</span> <span class="n">compareto</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">greater_than_ymax</span> <span class="o">|</span> <span class="n">less_than_ymin</span> <span class="o">|</span> <span class="n">models</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">|</span> \
          <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span> <span class="o">&amp;</span> \
          <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">compute_bounding_box</span><span class="p">(</span><span class="n">slit2detector</span><span class="p">,</span> <span class="n">wavelength_range</span><span class="p">,</span> <span class="n">slit_ymin</span><span class="o">=-.</span><span class="mi">55</span><span class="p">,</span> <span class="n">slit_ymax</span><span class="o">=.</span><span class="mi">55</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the bounding box of the projection of a slit/slice on the detector.</span>

<span class="sd">    The edges of the slit are used to determine the location</span>
<span class="sd">    of the projection of the slit on the detector.</span>
<span class="sd">    Because the trace is curved and the wavelength_range may span the</span>
<span class="sd">    two detectors, y_min of the projection may be at an arbitrary wavelength.</span>
<span class="sd">    The transform is run with a regularly sampled wavelengths to determin y_min.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    slit2detector : `astropy.modeling.core.Model`</span>
<span class="sd">        The transform from slit to detector.</span>
<span class="sd">    wavelength_range : tuple</span>
<span class="sd">        The wavelength range for the combination of grating and filter.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lam_min</span><span class="p">,</span> <span class="n">lam_max</span> <span class="o">=</span> <span class="n">wavelength_range</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">lam_max</span> <span class="o">-</span> <span class="n">lam_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">lam_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lam_min</span><span class="p">,</span> <span class="n">lam_max</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span>
    <span class="n">x_range_low</span><span class="p">,</span> <span class="n">y_range_low</span> <span class="o">=</span> <span class="n">slit2detector</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nsteps</span><span class="p">,</span> <span class="p">[</span><span class="n">slit_ymin</span><span class="p">]</span> <span class="o">*</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">lam_grid</span><span class="p">)</span>
    <span class="n">x_range_high</span><span class="p">,</span> <span class="n">y_range_high</span> <span class="o">=</span> <span class="n">slit2detector</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nsteps</span><span class="p">,</span> <span class="p">[</span><span class="n">slit_ymax</span><span class="p">]</span> <span class="o">*</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">lam_grid</span><span class="p">)</span>
    <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x_range_low</span><span class="p">,</span> <span class="n">x_range_high</span><span class="p">))</span>

    <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">y_range_low</span><span class="p">,</span> <span class="n">y_range_high</span><span class="p">))</span>
    <span class="c1"># add 10 px margin</span>
    <span class="c1"># The -1 is technically because the output of slit2detector is 1-based coordinates.</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_range</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2047</span><span class="p">,</span> <span class="n">x_range</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
    <span class="c1"># add 2 px margin</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_range</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2047</span><span class="p">,</span> <span class="n">y_range</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">bounding_box</span> <span class="o">=</span> <span class="p">((</span><span class="n">x0</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">x1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="n">y0</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">bounding_box</span>


<span class="k">def</span> <span class="nf">collimator_to_gwa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span> <span class="n">disperser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform from collimator to ``gwa`` frame.</span>

<span class="sd">    Includes the transforms:</span>
<span class="sd">    - through the collimator (going from sky to detector)</span>
<span class="sd">    - converting from unitless to directional cosines</span>
<span class="sd">    - a 3D rotation before the GWA using th ecorrected disperser angles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reference_files: dict</span>
<span class="sd">        Dictionary with reference files returned by CRDS.</span>
<span class="sd">    disperser : dict</span>
<span class="sd">        A corrected disperser ASDF object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~astropy.modeling.core.Model` model.</span>
<span class="sd">        Transform from collimator to ``gwa`` frame.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">CollimatorModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;collimator&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">collimator</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">model</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;theta_x&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;theta_y&#39;</span><span class="p">],</span>
              <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;theta_z&#39;</span><span class="p">],</span> <span class="n">disperser</span><span class="p">[</span><span class="s1">&#39;tilt_y&#39;</span><span class="p">]]</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="n">Rotation3DToGWA</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;xyzy&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span>
    <span class="n">u2dircos</span> <span class="o">=</span> <span class="n">Unitless2DirCos</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;unitless2directional_cosines&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">collimator</span><span class="o">.</span><span class="n">inverse</span> <span class="o">|</span> <span class="n">u2dircos</span> <span class="o">|</span> <span class="n">rotation</span>


<span class="k">def</span> <span class="nf">get_disperser</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">disperserfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the disperser data model with the GWA</span>
<span class="sd">    correction applied.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : `jwst.datamodels.DataModel`</span>
<span class="sd">        The input data model - either an ImageModel or a CubeModel.</span>
<span class="sd">    disperserfile : str</span>
<span class="sd">        The name of the disperser reference file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    disperser : dict</span>
<span class="sd">        The corrected disperser information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">disperser</span> <span class="o">=</span> <span class="n">DisperserModel</span><span class="p">(</span><span class="n">disperserfile</span><span class="p">)</span>
    <span class="n">xtilt</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">gwa_xtilt</span>
    <span class="n">ytilt</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">gwa_ytilt</span>
    <span class="n">disperser</span> <span class="o">=</span> <span class="n">correct_tilt</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">xtilt</span><span class="p">,</span> <span class="n">ytilt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">disperser</span>


<span class="k">def</span> <span class="nf">correct_tilt</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">xtilt</span><span class="p">,</span> <span class="n">ytilt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct the tilt of the grating by a measured grating tilt angle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xtilt : float</span>
<span class="sd">        Value of GWAXTILT keyword - angle in arcsec</span>
<span class="sd">    ytilt : float</span>
<span class="sd">        Value of GWAYTILT keyword - angle in arcsec</span>
<span class="sd">    disperser : `~jwst.datamodels.DisperserModel`</span>
<span class="sd">        Disperser information.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The GWA_XTILT keyword is used to correct the THETA_Y angle.</span>
<span class="sd">    The GWA_YTILT keyword is used to correct the THETA_X angle.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    disp : `~jwst.datamodels.DisperserModel`</span>
<span class="sd">        Corrected DisperserModel.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_get_correction</span><span class="p">(</span><span class="n">gwa_tilt</span><span class="p">,</span> <span class="n">tilt_angle</span><span class="p">):</span>
        <span class="n">phi_exposure</span> <span class="o">=</span> <span class="n">gwa_tilt</span><span class="o">.</span><span class="n">tilt_model</span><span class="p">(</span><span class="n">tilt_angle</span><span class="p">)</span>
        <span class="n">phi_calibrator</span> <span class="o">=</span> <span class="n">gwa_tilt</span><span class="o">.</span><span class="n">tilt_model</span><span class="p">(</span><span class="n">gwa_tilt</span><span class="o">.</span><span class="n">zeroreadings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">del_theta</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi_exposure</span> <span class="o">-</span> <span class="n">phi_calibrator</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3600.</span> <span class="c1">#in deg</span>
        <span class="k">return</span> <span class="n">del_theta</span>

    <span class="n">disp</span> <span class="o">=</span> <span class="n">disperser</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">disperser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;gwa_ytilt is </span><span class="si">{0}</span><span class="s2"> deg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ytilt</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;gwa_xtilt is </span><span class="si">{0}</span><span class="s2"> deg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xtilt</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">xtilt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">theta_y_correction</span> <span class="o">=</span> <span class="n">_get_correction</span><span class="p">(</span><span class="n">disp</span><span class="o">.</span><span class="n">gwa_tiltx</span><span class="p">,</span> <span class="n">xtilt</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;theta_y correction: </span><span class="si">{0}</span><span class="s1"> deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">theta_y_correction</span><span class="p">))</span>
        <span class="n">disp</span><span class="p">[</span><span class="s1">&#39;theta_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disp</span><span class="o">.</span><span class="n">theta_y</span> <span class="o">+</span> <span class="n">theta_y_correction</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;gwa_xtilt not applied&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ytilt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">theta_x_correction</span> <span class="o">=</span> <span class="n">_get_correction</span><span class="p">(</span><span class="n">disp</span><span class="o">.</span><span class="n">gwa_tilty</span><span class="p">,</span> <span class="n">ytilt</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;theta_x correction: </span><span class="si">{0}</span><span class="s1"> deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">theta_x_correction</span><span class="p">))</span>
        <span class="n">disp</span><span class="o">.</span><span class="n">theta_x</span> <span class="o">=</span> <span class="n">disp</span><span class="o">.</span><span class="n">theta_x</span> <span class="o">+</span> <span class="n">theta_x_correction</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;gwa_ytilt not applied&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">disp</span>


<span class="k">def</span> <span class="nf">ifu_msa_to_oteip</span><span class="p">(</span><span class="n">reference_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform from ``msa_frame`` to ``oteip`` for IFU exposures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reference_files: dict</span>
<span class="sd">        Dictionary with reference files returned by CRDS.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~astropy.modeling.core.Model` model.</span>
<span class="sd">        Transform from MSA to OTEIP.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">FOREModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;fore&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">fore</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">model</span>

    <span class="n">msa2fore_mapping</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;msa2fore_mapping&#39;</span><span class="p">)</span>
    <span class="n">msa2fore_mapping</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fore2msa&#39;</span><span class="p">)</span>
    <span class="n">fore_transform</span> <span class="o">=</span> <span class="n">msa2fore_mapping</span> <span class="o">|</span> <span class="n">fore</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fore_transform</span>


<span class="k">def</span> <span class="nf">msa_to_oteip</span><span class="p">(</span><span class="n">reference_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform from ``msa_frame`` to ``oteip`` for non IFU exposures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reference_files: dict</span>
<span class="sd">        Dictionary with reference files returned by CRDS.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~astropy.modeling.core.Model` model.</span>
<span class="sd">        Transform from MSA to OTEIP.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">FOREModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;fore&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">fore</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">model</span>
    <span class="n">msa2fore_mapping</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;msa2fore_mapping&#39;</span><span class="p">)</span>
    <span class="n">msa2fore_mapping</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">msa2fore_mapping</span> <span class="o">|</span> <span class="p">(</span><span class="n">fore</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">oteip_to_v23</span><span class="p">(</span><span class="n">reference_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform from ``oteip`` frame to ``v2v3`` frame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reference_files: dict</span>
<span class="sd">        Dictionary with reference files returned by CRDS.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~astropy.modeling.core.Model` model.</span>
<span class="sd">        Transform from ``oteip`` to ``v2v3`` frame.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">OTEModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;ote&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">ote</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">model</span>
    <span class="n">fore2ote_mapping</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fore2ote_mapping&#39;</span><span class="p">)</span>
    <span class="n">fore2ote_mapping</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="c1"># Create the transform to v2/v3/lambda.  The wavelength units up to this point are</span>
    <span class="c1"># meters as required by the pipeline but the desired output wavelength units is microns.</span>
    <span class="c1"># So we are going to Scale the spectral units by 1e6 (meters -&gt; microns)</span>
    <span class="c1"># The spatial units are currently in deg. Convertin to arcsec.</span>
    <span class="n">oteip2v23</span> <span class="o">=</span> <span class="n">fore2ote_mapping</span> <span class="o">|</span> <span class="p">(</span><span class="n">ote</span> <span class="o">&amp;</span> <span class="n">Scale</span><span class="p">(</span><span class="mf">1e6</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">oteip2v23</span>


<span class="k">def</span> <span class="nf">create_frames</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the coordinate frames in the NIRSPEC WCS pipeline.</span>

<span class="sd">    These are</span>
<span class="sd">    &quot;detector&quot;, &quot;gwa&quot;, &quot;slit_frame&quot;, &quot;msa_frame&quot;, &quot;oteip&quot;, &quot;v2v3&quot;, &quot;world&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">sca</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sca&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">gwa</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gwa&quot;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">),</span>
                      <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;alpha_in&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_in&#39;</span><span class="p">))</span>
    <span class="n">msa_spatial</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;msa_spatial&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">),</span>
                             <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x_msa&#39;</span><span class="p">,</span> <span class="s1">&#39;y_msa&#39;</span><span class="p">))</span>
    <span class="n">slit_spatial</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;slit_spatial&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                             <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x_slit&#39;</span><span class="p">,</span> <span class="s1">&#39;y_slit&#39;</span><span class="p">))</span>
    <span class="n">sky</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CelestialFrame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sky&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">reference_frame</span><span class="o">=</span><span class="n">coord</span><span class="o">.</span><span class="n">ICRS</span><span class="p">())</span>
    <span class="n">v2v3_spatial</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;v2v3_spatial&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">),</span>
                             <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;V2&#39;</span><span class="p">,</span> <span class="s1">&#39;V3&#39;</span><span class="p">))</span>

    <span class="c1"># The oteip_to_v23 incorporates a scale to convert the spectral units from</span>
    <span class="c1"># meters to microns.  So the v2v3 output frame will be in u.deg, u.deg, u.micron</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">SpectralFrame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;spectral&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">,),</span>
                            <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,))</span>
    <span class="n">v2v3</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CompositeFrame</span><span class="p">([</span><span class="n">v2v3_spatial</span><span class="p">,</span> <span class="n">spec</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;v2v3&#39;</span><span class="p">)</span>
    <span class="n">slit_frame</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CompositeFrame</span><span class="p">([</span><span class="n">slit_spatial</span><span class="p">,</span> <span class="n">spec</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;slit_frame&#39;</span><span class="p">)</span>
    <span class="n">msa_frame</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CompositeFrame</span><span class="p">([</span><span class="n">msa_spatial</span><span class="p">,</span> <span class="n">spec</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;msa_frame&#39;</span><span class="p">)</span>
    <span class="n">oteip_spatial</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;oteip&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                               <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;X_OTEIP&#39;</span><span class="p">,</span> <span class="s1">&#39;Y_OTEIP&#39;</span><span class="p">))</span>
    <span class="n">oteip</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CompositeFrame</span><span class="p">([</span><span class="n">oteip_spatial</span><span class="p">,</span> <span class="n">spec</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;oteip&#39;</span><span class="p">)</span>
    <span class="n">world</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CompositeFrame</span><span class="p">([</span><span class="n">sky</span><span class="p">,</span> <span class="n">spec</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">det</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">gwa</span><span class="p">,</span> <span class="n">slit_frame</span><span class="p">,</span> <span class="n">msa_frame</span><span class="p">,</span> <span class="n">oteip</span><span class="p">,</span> <span class="n">v2v3</span><span class="p">,</span> <span class="n">world</span>


<span class="k">def</span> <span class="nf">create_imaging_frames</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the coordinate frames in the NIRSPEC WCS pipeline.</span>
<span class="sd">    These are</span>
<span class="sd">    &quot;detector&quot;, &quot;gwa&quot;, &quot;msa_frame&quot;, &quot;oteip&quot;, &quot;v2v3&quot;, &quot;world&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">sca</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sca&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">gwa</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gwa&quot;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">),</span>
                      <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;alpha_in&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_in&#39;</span><span class="p">))</span>
    <span class="n">msa</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;msa&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">),</span>
                             <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x_msa&#39;</span><span class="p">,</span> <span class="s1">&#39;y_msa&#39;</span><span class="p">))</span>
    <span class="n">v2v3</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;v2v3&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">),</span>
                              <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;v2&#39;</span><span class="p">,</span> <span class="s1">&#39;v3&#39;</span><span class="p">))</span>
    <span class="n">oteip</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;oteip&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                               <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x_oteip&#39;</span><span class="p">,</span> <span class="s1">&#39;y_oteip&#39;</span><span class="p">))</span>
    <span class="n">world</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CelestialFrame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">reference_frame</span><span class="o">=</span><span class="n">coord</span><span class="o">.</span><span class="n">ICRS</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">det</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">gwa</span><span class="p">,</span> <span class="n">msa</span><span class="p">,</span> <span class="n">oteip</span><span class="p">,</span> <span class="n">v2v3</span><span class="p">,</span> <span class="n">world</span>


<span class="k">def</span> <span class="nf">get_slit_location_model</span><span class="p">(</span><span class="n">slitdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The transform for the absolute position of a slit on the MSA.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    slitdata : ndarray</span>
<span class="sd">        An array of shape (5,) with elements:</span>
<span class="sd">        slit_id, xcenter, ycenter, xsize, ysize</span>
<span class="sd">        This is the slit info in the MSa description file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : `~astropy.modeling.core.Model` model.</span>
<span class="sd">        A model which transforms relative position on the slit to</span>
<span class="sd">        absolute positions in the quadrant..</span>
<span class="sd">        This is later combined with the quadrant model to return</span>
<span class="sd">        absolute positions in the MSA.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num</span><span class="p">,</span> <span class="n">xcenter</span><span class="p">,</span> <span class="n">ycenter</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span> <span class="o">=</span> <span class="n">slitdata</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">xsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">models</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">ysize</span><span class="p">)</span> <span class="o">|</span> \
            <span class="n">models</span><span class="o">.</span><span class="n">Shift</span><span class="p">(</span><span class="n">xcenter</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">models</span><span class="o">.</span><span class="n">Shift</span><span class="p">(</span><span class="n">ycenter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">gwa_to_ymsa</span><span class="p">(</span><span class="n">msa2gwa_model</span><span class="p">,</span> <span class="n">lam_cen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the linear relation d_y(beta_in) for the aperture on the detector.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msa2gwa_model : `astropy.modeling.core.Model`</span>
<span class="sd">        The transform from the MSA to the GWA.</span>
<span class="sd">    lam_cen : float</span>
<span class="sd">        Central wavelength in meters.</span>
<span class="sd">    slit : `~jwst.transforms.models.Slit`</span>
<span class="sd">        A Fixed slit or MOS slitlet.</span>
<span class="sd">    slit_y_range: list or tuple of size 2</span>
<span class="sd">        The lower and upper limit of the slit.</span>
<span class="sd">        Used for IFU mode only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nstep</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="k">if</span> <span class="n">slit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">slit</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">slit</span><span class="o">.</span><span class="n">ymax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The case of IFU data.</span>
        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">slit_y_range</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">nstep</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lam_cen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># IFU case where IFUPOST has a wavelength dependent distortion</span>
        <span class="n">cosin_grating_k</span> <span class="o">=</span> <span class="n">msa2gwa_model</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="p">[</span><span class="n">lam_cen</span><span class="p">]</span> <span class="o">*</span> <span class="n">nstep</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cosin_grating_k</span> <span class="o">=</span> <span class="n">msa2gwa_model</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="n">beta_in</span> <span class="o">=</span> <span class="n">cosin_grating_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">tab</span> <span class="o">=</span> <span class="n">Tabular1D</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="p">(</span><span class="n">beta_in</span><span class="p">,),</span>
                    <span class="n">lookup_table</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tabular&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tab</span>


<div class="viewcode-block" id="nrs_wcs_set_input"><a class="viewcode-back" href="../../../api/jwst.assign_wcs.nrs_wcs_set_input.html#jwst.assign_wcs.nrs_wcs_set_input">[docs]</a><span class="k">def</span> <span class="nf">nrs_wcs_set_input</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">slit_name</span><span class="p">,</span> <span class="n">wavelength_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a WCS object for a specific slit, slice or shutter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : `~jwst.datamodels.DataModel`</span>
<span class="sd">        A WCS object for the all open slitlets in an observation.</span>
<span class="sd">    slit_name : int or str</span>
<span class="sd">        Slit.name of an open slit.</span>
<span class="sd">    wavelength_range: list</span>
<span class="sd">        Wavelength range for the combination of fliter and grating.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wcsobj : `~gwcs.wcs.WCS`</span>
<span class="sd">        WCS object for this slit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">copy</span> <span class="c1"># TODO: Add a copy method to gwcs.WCS</span>
    <span class="n">wcsobj</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span>
    <span class="k">if</span> <span class="n">wavelength_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">wrange</span> <span class="o">=</span> <span class="n">spectral_order_wrange_from_model</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wrange</span> <span class="o">=</span> <span class="n">wavelength_range</span>
    <span class="n">slit_wcs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">wcsobj</span><span class="p">)</span>
    <span class="n">slit_wcs</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="s1">&#39;sca&#39;</span><span class="p">,</span> <span class="s1">&#39;gwa&#39;</span><span class="p">,</span> <span class="n">wcsobj</span><span class="o">.</span><span class="n">pipeline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="c1"># get the open slits from the model</span>
    <span class="c1"># Need them to get the slit ymin,ymax</span>
    <span class="n">g2s</span> <span class="o">=</span> <span class="n">wcsobj</span><span class="o">.</span><span class="n">pipeline</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span>
    <span class="n">open_slits</span> <span class="o">=</span> <span class="n">g2s</span><span class="o">.</span><span class="n">slits</span>

    <span class="n">slit_wcs</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="s1">&#39;gwa&#39;</span><span class="p">,</span> <span class="s1">&#39;slit_frame&#39;</span><span class="p">,</span> <span class="n">g2s</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">slit_name</span><span class="p">))</span>

    <span class="n">exp_type</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">type</span>
    <span class="n">is_nirspec_ifu</span> <span class="o">=</span> <span class="n">is_nrs_ifu_lamp</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">exp_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;nrs_ifu&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_nirspec_ifu</span><span class="p">:</span>
        <span class="n">slit_wcs</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="s1">&#39;slit_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;slicer&#39;</span><span class="p">,</span>
                           <span class="n">wcsobj</span><span class="o">.</span><span class="n">pipeline</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">slit_name</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slit_wcs</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="s1">&#39;slit_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;msa_frame&#39;</span><span class="p">,</span>
                           <span class="n">wcsobj</span><span class="o">.</span><span class="n">pipeline</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">slit_name</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">slit2detector</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;slit_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;detector&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_nirspec_ifu</span><span class="p">:</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">compute_bounding_box</span><span class="p">(</span><span class="n">slit2detector</span><span class="p">,</span> <span class="n">wrange</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slit</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">open_slits</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">slit_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">compute_bounding_box</span><span class="p">(</span><span class="n">slit2detector</span><span class="p">,</span> <span class="n">wrange</span><span class="p">,</span>
                                  <span class="n">slit_ymin</span><span class="o">=</span><span class="n">slit</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">slit_ymax</span><span class="o">=</span><span class="n">slit</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>

    <span class="n">slit_wcs</span><span class="o">.</span><span class="n">bounding_box</span> <span class="o">=</span> <span class="n">bb</span>
    <span class="k">return</span> <span class="n">slit_wcs</span></div>


<span class="k">def</span> <span class="nf">validate_open_slits</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">open_slits</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove slits which do not project on the detector from the list of open slits.</span>
<span class="sd">    For each slit computes the transform from the slit to the detector and</span>
<span class="sd">    determines the bounding box.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : jwst.datamodels.DataModel</span>
<span class="sd">        Input data model</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slit2det : dict</span>
<span class="sd">        A dictionary with the slit to detector transform for each slit,</span>
<span class="sd">        {slit_id: astropy.modeling.Model}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_is_valid_slit</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
        <span class="n">xlow</span><span class="p">,</span> <span class="n">xhigh</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xlow</span> <span class="o">&gt;=</span> <span class="mi">2048</span> <span class="ow">or</span> <span class="n">ylow</span> <span class="o">&gt;=</span> <span class="mi">2048</span> <span class="ow">or</span> <span class="n">xhigh</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">yhigh</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="n">det2dms</span> <span class="o">=</span> <span class="n">dms_to_sca</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span><span class="o">.</span><span class="n">inverse</span>
    <span class="c1"># read models from reference file</span>
    <span class="n">disperser</span> <span class="o">=</span> <span class="n">DisperserModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;disperser&#39;</span><span class="p">])</span>
    <span class="n">disperser</span> <span class="o">=</span> <span class="n">correct_tilt</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">gwa_xtilt</span><span class="p">,</span>
                             <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">gwa_ytilt</span><span class="p">)</span>

    <span class="n">order</span><span class="p">,</span> <span class="n">wrange</span> <span class="o">=</span> <span class="n">get_spectral_order_wrange</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span>
                                              <span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;wavelengthrange&#39;</span><span class="p">])</span>

    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_start</span> <span class="o">=</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_end</span> <span class="o">=</span> <span class="n">wrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">spectral_order</span> <span class="o">=</span> <span class="n">order</span>
    <span class="n">agreq</span> <span class="o">=</span> <span class="n">angle_from_disperser</span><span class="p">(</span><span class="n">disperser</span><span class="p">,</span> <span class="n">input_model</span><span class="p">)</span>
    <span class="c1"># GWA to detector</span>
    <span class="n">det2gwa</span> <span class="o">=</span> <span class="n">detector_to_gwa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span>
                              <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span><span class="p">,</span>
                              <span class="n">disperser</span><span class="p">)</span>
    <span class="n">gwa2det</span> <span class="o">=</span> <span class="n">det2gwa</span><span class="o">.</span><span class="n">inverse</span>
    <span class="c1"># collimator to GWA</span>
    <span class="n">collimator2gwa</span> <span class="o">=</span> <span class="n">collimator_to_gwa</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span> <span class="n">disperser</span><span class="p">)</span>

    <span class="n">msa</span> <span class="o">=</span> <span class="n">MSAModel</span><span class="p">(</span><span class="n">reference_files</span><span class="p">[</span><span class="s1">&#39;msa&#39;</span><span class="p">])</span>
    <span class="n">col2det</span> <span class="o">=</span> <span class="n">collimator2gwa</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">Mapping</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">|</span> <span class="n">agreq</span> <span class="o">|</span> \
            <span class="n">gwa2det</span> <span class="o">|</span> <span class="n">det2dms</span>
    <span class="k">for</span> <span class="n">quadrant</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">slits_in_quadrant</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">open_slits</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">quadrant</span> <span class="o">==</span> <span class="n">quadrant</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">slits_in_quadrant</span><span class="p">):</span>
            <span class="n">msa_quadrant</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">msa</span><span class="p">,</span> <span class="s2">&quot;Q</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quadrant</span><span class="p">))</span>
            <span class="n">msa_model</span> <span class="o">=</span> <span class="n">msa_quadrant</span><span class="o">.</span><span class="n">model</span>
            <span class="n">msa_data</span> <span class="o">=</span> <span class="n">msa_quadrant</span><span class="o">.</span><span class="n">data</span>
            <span class="k">for</span> <span class="n">slit</span> <span class="ow">in</span> <span class="n">slits_in_quadrant</span><span class="p">:</span>
                <span class="n">slit_id</span> <span class="o">=</span> <span class="n">slit</span><span class="o">.</span><span class="n">shutter_id</span>
                <span class="n">slitdata</span> <span class="o">=</span> <span class="n">msa_data</span><span class="p">[</span><span class="n">slit_id</span><span class="p">]</span>
                <span class="n">slitdata_model</span> <span class="o">=</span> <span class="n">get_slit_location_model</span><span class="p">(</span><span class="n">slitdata</span><span class="p">)</span>
                <span class="n">msa_transform</span> <span class="o">=</span> <span class="n">slitdata_model</span> <span class="o">|</span> <span class="n">msa_model</span>
                <span class="n">msa2det</span> <span class="o">=</span> <span class="n">msa_transform</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">col2det</span>
                <span class="n">bb</span> <span class="o">=</span> <span class="n">compute_bounding_box</span><span class="p">(</span><span class="n">msa2det</span><span class="p">,</span> <span class="n">wrange</span><span class="p">,</span> <span class="n">slit</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">slit</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">_is_valid_slit</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing slit </span><span class="si">{0}</span><span class="s2"> from the list of open slits because the &quot;</span>
                             <span class="s2">&quot;WCS bounding_box is completely outside the detector.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Slit bounding_box is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb</span><span class="p">))</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">slit</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">open_slits</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">open_slits</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="n">msa</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">open_slits</span>


<span class="k">def</span> <span class="nf">spectral_order_wrange_from_model</span><span class="p">(</span><span class="n">input_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the spectral order and wavelength range used in the WCS.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : jwst.datamodels.DataModel</span>
<span class="sd">        The data model. Must have been through the assign_wcs step.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_start</span><span class="p">,</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">waverange_end</span><span class="p">]</span>
    <span class="n">spectral_order</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">spectral_order</span>
    <span class="k">return</span> <span class="n">spectral_order</span><span class="p">,</span> <span class="n">wrange</span>


<div class="viewcode-block" id="nrs_ifu_wcs"><a class="viewcode-back" href="../../../api/jwst.assign_wcs.nrs_ifu_wcs.html#jwst.assign_wcs.nrs_ifu_wcs">[docs]</a><span class="k">def</span> <span class="nf">nrs_ifu_wcs</span><span class="p">(</span><span class="n">input_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of WCSs for all NIRSPEC IFU slits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : jwst.datamodels.DataModel</span>
<span class="sd">        The data model. Must have been through the assign_wcs step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">wrange</span> <span class="o">=</span> <span class="n">spectral_order_wrange_from_model</span><span class="p">(</span><span class="n">input_model</span><span class="p">)</span>
    <span class="n">wcs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># loop over all IFU slits</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">wcs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nrs_wcs_set_input</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">wrange</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">wcs_list</span></div>


<span class="k">def</span> <span class="nf">_create_ifupost_transform</span><span class="p">(</span><span class="n">ifupost_slice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an IFUPOST transform for a specific slice.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ifupost_slice : `jwst.datamodels.properties.ObjectNode`</span>
<span class="sd">        IFUPost transform for a specific slice</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">ifupost_slice</span><span class="o">.</span><span class="n">linear</span>
    <span class="n">polyx</span> <span class="o">=</span> <span class="n">ifupost_slice</span><span class="o">.</span><span class="n">xpoly</span>
    <span class="n">polyx_dist</span> <span class="o">=</span> <span class="n">ifupost_slice</span><span class="o">.</span><span class="n">xpoly_distortion</span>
    <span class="n">polyy</span> <span class="o">=</span> <span class="n">ifupost_slice</span><span class="o">.</span><span class="n">ypoly</span>
    <span class="n">polyy_dist</span> <span class="o">=</span> <span class="n">ifupost_slice</span><span class="o">.</span><span class="n">ypoly_distortion</span>

    <span class="c1"># the chromatic correction is done here</span>
    <span class="c1"># the input is Xslicer, Yslicer, lam</span>
    <span class="c1"># The wavelength dependent polynomial is</span>
    <span class="c1"># expressed as</span>
    <span class="c1"># poly_independent(x, y) + poly_dependent(x, y) * lambda</span>
    <span class="n">model_x</span> <span class="o">=</span> <span class="p">((</span><span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">polyx</span><span class="p">)</span> <span class="o">+</span>
                       <span class="p">((</span><span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">polyx_dist</span><span class="p">)</span> <span class="o">*</span>
                        <span class="p">(</span><span class="n">Mapping</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span> <span class="o">|</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">))))</span>
    <span class="n">model_y</span> <span class="o">=</span> <span class="p">((</span><span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">polyy</span><span class="p">)</span> <span class="o">+</span>
                       <span class="p">((</span><span class="n">Mapping</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_inputs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">polyy_dist</span><span class="p">)</span> <span class="o">*</span>
                        <span class="p">(</span><span class="n">Mapping</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span> <span class="o">|</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">))))</span>

    <span class="n">output2poly_mapping</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_outmap&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;ifupost&#39;</span><span class="p">))</span>
    <span class="n">output2poly_mapping</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">input2poly_mapping</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_inmap&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;ifupost&#39;</span><span class="p">))</span>
    <span class="n">input2poly_mapping</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">model_poly</span> <span class="o">=</span> <span class="n">input2poly_mapping</span> <span class="o">|</span> <span class="p">(</span><span class="n">model_x</span> <span class="o">&amp;</span> <span class="n">model_y</span><span class="p">)</span> <span class="o">|</span> <span class="n">output2poly_mapping</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">linear</span> <span class="o">&amp;</span> <span class="n">Identity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">model_poly</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">def</span> <span class="nf">nrs_lamp</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the appropriate function for lamp data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_model : `~jwst.datamodels.DataModel`</span>
<span class="sd">        The input data model.</span>
<span class="sd">    reference_files : dict</span>
<span class="sd">        The reference files used for this mode.</span>
<span class="sd">    slit_y_range : list</span>
<span class="sd">        The slit dimensions relative to the center of the slit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lamp_mode</span> <span class="o">=</span> <span class="n">input_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">lamp_mode</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lamp_mode</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">lamp_mode</span> <span class="o">=</span> <span class="n">lamp_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lamp_mode</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
    <span class="k">if</span> <span class="n">lamp_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fixedslit&#39;</span><span class="p">,</span> <span class="s1">&#39;brightobj&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">slits_wcs</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lamp_mode</span> <span class="o">==</span> <span class="s1">&#39;ifu&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ifu</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lamp_mode</span> <span class="o">==</span> <span class="s1">&#39;msaspec&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">slits_wcs</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">not_implemented_mode</span><span class="p">(</span><span class="n">input_model</span><span class="p">,</span> <span class="n">reference_files</span><span class="p">,</span> <span class="n">slit_y_range</span><span class="p">)</span>

<span class="n">exp_type2transform</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nrs_tacq&#39;</span><span class="p">:</span> <span class="n">imaging</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_taslit&#39;</span><span class="p">:</span> <span class="n">imaging</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_taconfirm&#39;</span><span class="p">:</span> <span class="n">imaging</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_confirm&#39;</span><span class="p">:</span> <span class="n">imaging</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_fixedslit&#39;</span><span class="p">:</span> <span class="n">slits_wcs</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_ifu&#39;</span><span class="p">:</span> <span class="n">ifu</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_msaspec&#39;</span><span class="p">:</span> <span class="n">slits_wcs</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_image&#39;</span><span class="p">:</span> <span class="n">imaging</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_focus&#39;</span><span class="p">:</span> <span class="n">imaging</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_mimf&#39;</span><span class="p">:</span> <span class="n">imaging</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_msata&#39;</span><span class="p">:</span> <span class="n">imaging</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_wata&#39;</span><span class="p">:</span> <span class="n">imaging</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_autoflat&#39;</span><span class="p">:</span> <span class="n">slits_wcs</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_autowave&#39;</span><span class="p">:</span> <span class="n">nrs_lamp</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_lamp&#39;</span><span class="p">:</span> <span class="n">nrs_lamp</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_brightobj&#39;</span><span class="p">:</span> <span class="n">slits_wcs</span><span class="p">,</span>
                      <span class="s1">&#39;nrs_dark&#39;</span><span class="p">:</span> <span class="n">not_implemented_mode</span><span class="p">,</span>
                      <span class="p">}</span>
</pre></div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3>Releases</h3>
<ul>
  <li><a href="../../../../0.2.0/index.html">0.2.0</a></li>
  <li><a href="../../../../0.3.0/index.html">0.3.0</a></li>
</ul>
<h3>In Development</h3>
<ul>
  <li><a href="nirspec.html">master</a></li>
</ul>


<h3>Page Contents</h3>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2020, Andrea Zonca, Arun Surya.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.2.1. &nbsp;
    Last built 28 Sep 2020. <br/>
  </p>
</footer>
  </body>
</html>